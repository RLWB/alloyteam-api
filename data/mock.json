[
  {
    "id": 0,
    "tags": ["WEB开发"],
    "title": "走向匿名化，谈谈微信小程序新授权登录",
    "author": "TAT.rikumi",
    "avatar": "https://secure.gravatar.com/avatar/591ab91f0b3da23015817afe5be86771?s=43",
    "date": "2015-08-21T09:54:17+00:00",
    "separator": "98732",
    "content": "\n\t\t<p>今年 2 月，微信团队针对小程序登录和用户信息获取进行了一次<a href=\"https://developers.weixin.qq.com/community/develop/doc/000cacfa20ce88df04cb468bc52801?blockType=1\">接口调整</a>，这一举动史无前例地撼动了几乎所有小程序开发者，在小程序社区产生了不小的反响。</p>\n<p>作为接入方，本文将从产品和技术两个角度，讨论微信新授权登录机制的设计目的、适配方案以及对产品带来的影响。</p>\n<p><span id=\"more-15431\"></span></p>\n<h2>历史渊源：授权、登录与获取用户信息</h2>\n<p>在微信问世之前，来自 Twitter 的 OAuth 模型就已经足够普及。在 OAuth 模型中，B 业务想要操作用户在 A 业务中的数据，需要首先跳转到 A 业务的页面，让用户直接与 A 业务进行确认，称为授权（Authorization），得到 A 业务颁发给 B 业务的「兑换码」（一般称为 code），并回跳到 B 业务；之后，B 业务使用这个兑换码，通过后端直接联系 A 业务，一次性获得用于操作 A 业务数据的一系列凭证，并进行保存，后续则可以使用这些凭证调用 A 业务中的操作。</p>\n<p>在 OAuth 模型中，Auth 这一缩写代表了两层含义：「授权（Authorization）」指用户直接联系 A 业务，对操作进行确认的过程；而「验证（Authentication）」则多指 A 业务对 B 业务的访问权进行校验的后续流程。</p>\n<p><strong>微信公众号网页开发</strong>实现了这一模型：</p>\n<p>对于<strong>授权</strong>，公众号网页需要先跳转到微信提供的授权页面，由用户点击确认授权（如果无需获取用户信息，或用户已经授权，或已经关注过服务号，则无需确认，但仍然需要进行这一次跳转），授权页面会回跳到公众号网页业务，并带上 code 到网页参数；之后，业务方则需要通过<strong>后端拦截</strong>或<strong>前端 Ajax 请求</strong>等方式，经由业务自己的后端换取微信颁发的 OpenID/UnionID 以及一个 access_token 凭证；</p>\n<p>对于<strong>登录</strong>，其本质是区分用户、颁发登录态。OpenID/UnionID 代表了用户在微信的身份信息，让业务后端能够区分相同和不同的用户，业务后端可以针对相同的用户颁发已有的登录态信息，访问同一个用户之前产生的数据；针对不同的用户，则可以创建新的帐号信息，下发新的登录态等；</p>\n<p>对于<strong>获取用户信息</strong>，后端可以用 access_token 向微信请求获得。</p>\n<h2>小程序老授权登录</h2>\n<p>在微信小程序中，由于微信客户端拥有控制力，第三方业务与微信之间不再需要跳转，只要调用微信提供的接口，微信客户端可以保证授权的有效性，因此授权登录相比网页开发较为简单，但这同时也意味着微信随时可以改变接口的行为。直到目前，小程序授权登录的行为发生过两次改动：</p>\n<p>小程序刚推出时，微信提供了 <code>wx.login</code> 和 <code>wx.getUserInfo</code> 两个接口，分别用于<strong>登录</strong>和<strong>授权获取用户信息</strong>；其中 <code>wx.login</code> 是静默的，会直接返回可换取 OpenID 的 code 和用于解密数据的 session_key；<code>wx.getUserInfo</code> 会弹出授权弹窗，经过授权后，会返回加密的用户数据，可以由后端凭 session_key 进行解密。加密的目的是为了防止用户篡改信息，从而限制违规头像昵称的产生，这一点不在本文的讨论范围内。</p>\n<p>此后不久，<code>wx.getUserInfo</code> 被改为不再主动弹出授权，而是会在未授权情况下静默失败；授权则需要使用微信提供的专门 button 组件进行触发，这是为了遏止部分小程序一启动就弹出授权，或在本来不需要用户信息的情况下超标获取的问题。对于一些使用 WebView 的小程序，由于 WebView 页面中无法承载原生的 button 组件，这次改动就需要使用一个原生的授权页面来适配。</p>\n<p>老的这一套授权登录流程虽然有它繁琐的地方，但长久以来，我们都忘记了其中最大的一个方便点：<strong>经过一次授权之后，小程序可以随时静默获取用户的信息。</strong>当用户更改了昵称或头像，只要打开已授权的小程序，小程序就能直接获取到修改后的信息，而无需用户再次授权。</p>\n<h2>新授权登录的产品形态</h2>\n<p>从官方文档中可以看出，小程序授权登录机制调整后，主要存在两个改动点：</p>\n<ol>\n<li>在 <code>wx.login</code> 接口中，现在可以直接获取到用户的 UnionID，而无需通过授权获得，这其实是修复了之前的 Bug，同时鼓励各小程序业务尽可能不超标获取用户信息，遵循权限最小化原则；</li>\n<li>新增了 <code>wx.getUserProfile</code> 接口，代替原来的 <code>wx.getUserInfo</code>，新的接口会主动弹出授权，但只能一次性获取当前的昵称头像，而且仍然需要在用户点击后调用。</li>\n</ol>\n<p>从产品角度而言，这两点分别带来了不同的变化：</p>\n<p>第一点对于需要获取 UnionID 的业务来说，可以让静默登录的能力真正可用。可以让用户在不授权昵称头像的情况下，使用尽可能多的功能，在需要时才提示授权，对于产品本身登录过程的转化率有很大帮助，同时也帮助微信保护用户隐私，是一个双赢的举措；</p>\n<p>而第二点变化则可以看作是微信对用户信息匿名化的一个尝试。在此之前，微信推出了自定义昵称头像的功能，可以在授权时设置自定义的昵称头像，区别于微信本身的昵称头像，实现一定的匿名使用；但由于老授权登录接口是一次授权，用户一旦设置了自定义的昵称头像就无法修改。因此，为了能将一次授权改为每次授权，微信通过新增一个接口，让开发者对这一行为进行主动适配。</p>\n<p>根据微信的要求，4 月 13 日之后，新发布的版本在支持 <code>wx.getUserProfile</code> 的情况下，不能再使用 <code>wx.getUserInfo</code>，否则将收到默认的昵称头像。从微信开发者工具中也可以提前看到这一改动：获取到的头像会变成一张默认头像，昵称变为「微信用户」。</p>\n<p>而适配这个接口也意味着产品交互需要发生改变，因为在此之后，一次授权只能获得一次性的昵称和头像，当用户对微信昵称头像进行了修改，小程序业务不但不能静默获取到修改后的昵称头像，完全无从得知头像昵称发生了变化，都必须通过重新授权才能实现。</p>\n<p>对于本来需要获取用户昵称头像的小程序业务，我们探讨了一种比较合理的适配方式：<strong>模拟原来的一次授权</strong>、并且<strong>提供手动修改头像昵称的入口</strong>。通过对登录逻辑的改造，可以实现尽可能模拟原有的授权交互，只在首次使用时进行授权，但经过这一次授权后，昵称头像不会再更新；因此需要提供手动修改头像昵称的入口，让用户对「头像昵称不会自动同步、可以手动更新或修改」的行为有预期。</p>\n<h2>技术适配方案：以文档小程序为例</h2>\n<p>在文档小程序中，原有的登录接口是二合一的，即前端先调用完 <code>wx.login</code> 和 <code>wx.getUserInfo</code>，得到 code 和加密的用户信息，然后一起调用后端接口，后端查询已有用户或创建新用户，并对用户头像昵称信息进行更新。</p>\n<p>在新授权登录的背景下，这样的后端接口已经无法满足要求。为了尽可能还原原有的一次授权交互，我们需要先判断用户是否已授权，然后根据是否已有昵称头像，决定是否调用授权并上传用户的昵称头像。另外，在用户选择手动更新昵称头像时，也需要有接口负责上传更新用户的昵称头像。</p>\n<p>因此，为了保持接口设计的合理性，我们将登录接口拆分成两个接口，并搭配获取业务用户信息的接口进行实现：</p>\n<ol>\n<li>前端调用 <code>wx.login</code>，得到 code，并调用后端登录接口，得到提前颁发的登录态；</li>\n<li>前端调用现有的获取业务用户信息接口，判断业务是否已获得昵称头像，如果已有昵称头像，直接保存 1 中的登录态，登录完成；</li>\n<li>如果还未获得昵称头像，则弹出授权，授权后调用后端上传昵称头像接口，将得到的昵称头像进行保存；</li>\n<li>根据产品交互设计，在用户选择更新昵称头像时，重复 3 中的步骤，授权并更新昵称头像。</li>\n</ol>\n<p>由于 <code>wx.getUserProfile</code> 只返回了明文的昵称头像等信息，我们还需要对上传昵称头像的接口接入内容安全保护，防止用户任意上传不合规的昵称头像信息。</p>\n<p>除此之外，在 QQ 小程序以及 PC/Mac 微信小程序的情况下，新的授权登录接口可能并没有支持，需要对不支持 <code>wx.getUserProfile</code> 接口的情况进行兼容，改用原有的授权登录逻辑。</p>\n<h2>总结</h2>\n<p>本文探讨了微信小程序新的授权登录机制。新的机制下，授权被局限于获取用户信息的一次性操作之内，从而在鼓励开发者尽可能少要求授权的同时，让用户隐私得到一定程度的保护。对于产品形态而言，这要求产品在交互上强化用户头像昵称的可定制性；从开发角度，则需要根据具体业务情况，投入一定的精力进行适配。</p>\n<p>与此同时，我们也能看出在小程序授权登录内外的一些细节问题：接口频繁变动、适配期限太匆忙，会导致开发者疲于适配，对平台产生消极情绪；另外，比起头像昵称这些常规信息的定制，真正属于用户隐私的手机号码、实名身份等信息仍然需要更严格的管控，才能在隐私安全的方向上走得更远。</p>\n<p>小程序是一个为控制力而生的平台，但我们更希望这样的控制力去约束不守规矩的开发者，管住一味营销、缺乏实用性的产品，放手让用心打磨的项目走得更远。</p>\n\t"
  },
  {
    "id": 1,
    "tags": ["WEB开发"],
    "title": "2020・AlloyTeam 腾讯文档前端团队招聘・Web 工程师",
    "author": "TAT.Alloy",
    "avatar": "http://www.alloyteam.com/wp-content/uploads/2015/01/AlloyTeam_avatar.png",
    "date": "2020-09-21T19:00:20+00:00",
    "separator": "112979",
    "content": "\n\t\t<blockquote>\n<p>腾讯 AlloyTeam 诚邀您加入团队，一起打造最好用的在线文档</p>\n</blockquote>\n<p>腾讯文档的推出标志着腾讯正式进军文档办公领域，目前市场反馈和项目前景都非常好，AlloyTeam 正在寻找优秀小伙伴加入腾讯文档项目，一起做业界最好的在线文档。 本次招聘中级、高级 web 工程师，岗位信息如下：</p>\n<h2>岗位名称：Web 前端开发工程师</h2>\n<h3 id=\"title-0\">岗位要求:</h3>\n<p><span id=\"more-8062\"></span></p>\n<ul>\n<li>熟悉 Javascript/CSS 及主流前端类库、框架、工具；</li>\n<li>熟悉 ES6/HTML5/CSS3 等新技术，对 JS 新特性、响应式布局、Web 动画等有深刻理解和使用经验优先；</li>\n<li>掌握前端效率工具 &amp;工作流开发。</li>\n<li>有良好的代码习惯，能编写出高效、高性能、具有高可维护性的代码。</li>\n<li>热爱前端，好学，喜欢在前端领域折腾。</li>\n<li>逻辑分析能力强，善于沟通，较强的学习能力，具备良好的沟通能力和团队协作精神。</li>\n</ul>\n<h2>岗位名称：高级 Web 前端开发工程师</h2>\n<h3 id=\"title-0\">岗位要求:</h3>\n<ul>\n<li>熟悉 Web 性能优化，有移动 Web 或 Hybrid App 或 RN 开发调试及优化经验者优先。</li>\n<li>掌握至少一门服务器端编程语言，熟悉 HTTP、HTTPS 等常见网络协议，有服务器运维经验者优先。</li>\n<li>能对现有产品和开发流程进行观察和思考，提出优化改进方案。</li>\n<li>较强的学习能力，具备良好的知识沉淀习惯，有技术博客撰写、Github 开源项目者优先。</li>\n<li>热爱分享，开源，有开源项目维护经验优先。</li>\n<li>能紧跟业界最新技术，最好是某个前端领域的专家。</li>\n<li>熟悉算法、熟悉富文本开发优先、对 AI 方面有兴趣优先。</li>\n<li>熟悉 excel 等文档格式优先。</li>\n<li>有实时通信系统开发经验优先。</li>\n<li>对协同编辑、大型 web 项目性能极限优化有浓厚的兴趣优先。</li>\n</ul>\n<p>如果愿意加入我们，请将简历发送至 <strong>alloyteam@qq.com</strong> ，期待您的回复。</p>\n<h2>工作地点：</h2>\n<p><strong>深圳腾讯大厦（总部）</strong> </p>\n<p><!--more--></p>\n<h1>关于 AlloyTeam</h1>\n<p>AlloyTeam 是国内影响力最大的前端团队之一，核心成员来自前 WebQQ 前端团队。AlloyTeam 负责过 WebQQ、QQ 群、兴趣部落、腾讯文档等大型 Web 项目，积累了许多丰富宝贵的 Web 开发经验。 在前端业界，AlloyTeam 贡献了 AlloyTouch、AlloyFinger、AlloyImage 等优秀开源项目，发起和组织了 TFC（腾讯 Web 前端大会）和 AlloyTeam Conf 等前端业界大会。 除了大厂的那些福利，比如健身房，医疗室，众多社团活动，免费早晚餐，上下班班车等等。作为卓越的前端技术团队，我们还有业界知名的前端大神，例如： </p>\n<h3 id=\"title-2\">畅销前端书《JavaScript 设计模式与开发实践》作者曾探</h3>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2018/05/CB3036FE@364BD0605-02-14-31-56.jpg\" alt=\"\"></p>\n<h3 id=\"title-3\">AlloyTeam 技术周刊负责人老教授</h3>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2018/05/2DC76592@3D05AD405-02-14-31-56.png\" alt=\"\"></p>\n<h3 id=\"title-4\">InfoQ, JSCONF, TFC, AC 等一流技术大会担任讲师、筹备 TFC，AC 大会，与一众前端大咖零距离接触学习的机会。</h3>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2018/05/9C903AC7@BC0ED5305-02-14-31-56.png\" alt=\"\"></p>\n<p>在这里你可以和 WebQQ、AlloyTouch、AlloyImage、CodeTank、《Javascript 设计模式与开发实践》等项目和书籍的作者一起经历 web 前端最有挑战的项目！ 这里技术氛围好，领导 nice、钱景好，无论你是身经百战的资深工程师，还是即将从学校步入社会的新人，只要你热爱挑战，希望前端技术和我们飞速提高，这里将是最适合你的地方。 如果愿意加入我们，请将简历发送至 <strong>alloyteam@qq.com</strong>，期待您的回复。</p>\n<p>PS：腾讯文档在 2018.4.18 正式对外发布，也许你已经看到过朋友圈流传的这个截图，关于一个需求也需要提 8 年的小马哥。<br>\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2018/05/C636020E@6DEA48105-02-14-31-56.png\" alt=\"\"></p>\n\t"
  },
  {
    "id": 2,
    "tags": ["WEB开发"],
    "title": "yield 学习",
    "author": "TAT.vorshen",
    "avatar": "http://www.alloyteam.com/wp-content/uploads/2015/06/vorshen_avatar_1435652666.png",
    "date": "2021-03-27T20:10:50+00:00",
    "separator": "6264",
    "content": "\n\t\t<blockquote>\n<p>腾讯 AlloyTeam 诚邀您加入团队，一起打造最好用的在线文档</p>\n</blockquote>\n<p>腾讯文档的推出标志着腾讯正式进军文档办公领域，目前市场反馈和项目前景都非常好，AlloyTeam 正在寻找优秀小伙伴加入腾讯文档项目，一起做业界最好的在线文档。 本次招聘中级、高级 web 工程师，岗位信息如下：</p>\n<h2>岗位名称：Web 前端开发工程师</h2>\n<h3 id=\"title-0\">岗位要求:</h3>\n<p><span id=\"more-8062\"></span></p>\n<ul>\n<li>熟悉 Javascript/CSS 及主流前端类库、框架、工具；</li>\n<li>熟悉 ES6/HTML5/CSS3 等新技术，对 JS 新特性、响应式布局、Web 动画等有深刻理解和使用经验优先；</li>\n<li>掌握前端效率工具 &amp;工作流开发。</li>\n<li>有良好的代码习惯，能编写出高效、高性能、具有高可维护性的代码。</li>\n<li>热爱前端，好学，喜欢在前端领域折腾。</li>\n<li>逻辑分析能力强，善于沟通，较强的学习能力，具备良好的沟通能力和团队协作精神。</li>\n</ul>\n<h2>岗位名称：高级 Web 前端开发工程师</h2>\n<h3 id=\"title-0\">岗位要求:</h3>\n<ul>\n<li>熟悉 Web 性能优化，有移动 Web 或 Hybrid App 或 RN 开发调试及优化经验者优先。</li>\n<li>掌握至少一门服务器端编程语言，熟悉 HTTP、HTTPS 等常见网络协议，有服务器运维经验者优先。</li>\n<li>能对现有产品和开发流程进行观察和思考，提出优化改进方案。</li>\n<li>较强的学习能力，具备良好的知识沉淀习惯，有技术博客撰写、Github 开源项目者优先。</li>\n<li>热爱分享，开源，有开源项目维护经验优先。</li>\n<li>能紧跟业界最新技术，最好是某个前端领域的专家。</li>\n<li>熟悉算法、熟悉富文本开发优先、对 AI 方面有兴趣优先。</li>\n<li>熟悉 excel 等文档格式优先。</li>\n<li>有实时通信系统开发经验优先。</li>\n<li>对协同编辑、大型 web 项目性能极限优化有浓厚的兴趣优先。</li>\n</ul>\n<p>如果愿意加入我们，请将简历发送至 <strong>alloyteam@qq.com</strong> ，期待您的回复。</p>\n<h2>工作地点：</h2>\n<p><strong>深圳腾讯大厦（总部）</strong> </p>\n<p><!--more--></p>\n<h1>关于 AlloyTeam</h1>\n<p>AlloyTeam 是国内影响力最大的前端团队之一，核心成员来自前 WebQQ 前端团队。AlloyTeam 负责过 WebQQ、QQ 群、兴趣部落、腾讯文档等大型 Web 项目，积累了许多丰富宝贵的 Web 开发经验。 在前端业界，AlloyTeam 贡献了 AlloyTouch、AlloyFinger、AlloyImage 等优秀开源项目，发起和组织了 TFC（腾讯 Web 前端大会）和 AlloyTeam Conf 等前端业界大会。 除了大厂的那些福利，比如健身房，医疗室，众多社团活动，免费早晚餐，上下班班车等等。作为卓越的前端技术团队，我们还有业界知名的前端大神，例如： </p>\n<h3 id=\"title-2\">畅销前端书《JavaScript 设计模式与开发实践》作者曾探</h3>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2018/05/CB3036FE@364BD0605-02-14-31-56.jpg\" alt=\"\"></p>\n<h3 id=\"title-3\">AlloyTeam 技术周刊负责人老教授</h3>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2018/05/2DC76592@3D05AD405-02-14-31-56.png\" alt=\"\"></p>\n<h3 id=\"title-4\">InfoQ, JSCONF, TFC, AC 等一流技术大会担任讲师、筹备 TFC，AC 大会，与一众前端大咖零距离接触学习的机会。</h3>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2018/05/9C903AC7@BC0ED5305-02-14-31-56.png\" alt=\"\"></p>\n<p>在这里你可以和 WebQQ、AlloyTouch、AlloyImage、CodeTank、《Javascript 设计模式与开发实践》等项目和书籍的作者一起经历 web 前端最有挑战的项目！ 这里技术氛围好，领导 nice、钱景好，无论你是身经百战的资深工程师，还是即将从学校步入社会的新人，只要你热爱挑战，希望前端技术和我们飞速提高，这里将是最适合你的地方。 如果愿意加入我们，请将简历发送至 <strong>alloyteam@qq.com</strong>，期待您的回复。</p>\n<p>PS：腾讯文档在 2018.4.18 正式对外发布，也许你已经看到过朋友圈流传的这个截图，关于一个需求也需要提 8 年的小马哥。<br>\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2018/05/C636020E@6DEA48105-02-14-31-56.png\" alt=\"\"></p>\n\t"
  },
  {
    "id": 3,
    "tags": ["WEB开发"],
    "title": "提高资源的安全性 – SRI 与 CSP",
    "author": "TAT.joeyguo",
    "avatar": "http://www.alloyteam.com/wp-content/uploads/2015/12/TAT.joey_avatar_1451283400-43x43.jpg",
    "date": "2021-01-14T19:37:37+00:00",
    "separator": "4432",
    "content": "\n\t\t<p><a href=\"https://github.com/joeyguo/blog/issues/26\">原文地址</a></p>\n<p>在 <a href=\"https://github.com/joeyguo/blog/issues/25\">《前端资源加载失败优化》</a>文章中，我们聊到了前端资源加载失败的监控方式，以及资源加载失败时的优化方案。通过对加载失败的资源更换域名动态重新加载、同时确保最终代码正常的执行顺序，从而有效地减少了因为资源加载失败导致的网页异常。到此，资源文件成功加载了！但加载到的是否就是正确的资源呢？是否会在加载过程中被半路劫持？此时又该如何监控？是否还能做更多的防护措施呢？本文将逐步进行分析。</p>\n<p><span id=\"more-15384\"></span></p>\n<h1>流量劫持</h1>\n<p>流量劫持在 Web 项目中是一个老生常谈的话题了，常见的劫持方式是往 JS 代码文件中注入一段脚本，从而实现一段广告 “完美” 植入，而当注入的位置稍有偏差，导致代码执行异常，页面将完全不可用。</p>\n<p><img src=\"https://user-images.githubusercontent.com/10385585/104551945-c9fd1900-5672-11eb-8ffe-1aeb7d30f410.png\" alt=\"e (1)\"></p>\n<h2>HTTPS</h2>\n<p>上面现象在使用以明文传输、不带加密的 HTTP 协议中经常遇到，毕竟流量在传输过程中裸奔，劫持轻而易举。HTTPS 应运而生，通过证书加密等方式保证了传输过程中的数据完整性，开启 HTTPS 后，这类劫持问题基本不复存在了。</p>\n<p>原本以为就此安稳一生，直到有一天，钟声再次响起，有用户反馈访问页面时看到了广告、还有的打开页面后白屏。通过具体的定位分析，最终发现返回的 CDN 文件只剩一半内容。</p>\n<p>难道 HTTPS 协议被破译了吗？其实并不是。</p>\n<p>HTTPS 是可以有效应对流量劫持的问题，然而很多提供 HTTPS 的 CDN 服务在回源的时候采用的 HTTP 协议，流量劫持便有机可乘，那么开启全链路的 HTTPS 是否就万无一失了呢？大部分情况确实如此。但如果遇到 CDN 服务入侵、源头污染，或者用户信任了异常证书导致的中间人劫持，千里之堤，溃于蚁穴，防御之门被摧毁后，依然任人宰割。为了尽可能的安全，或许我们可以再加一道防线，那就是 SRI。</p>\n<h1>SRI（Subresource Integrity）</h1>\n<p>SRI 是用来校验资源是否完整的安全方案。通过为页面引用的资源指定信息摘要，当资源被劫持篡改内容时，浏览器校验信息摘要不匹配，将会拒绝代码执行并抛出加载异常，保证加载资源的完整性。</p>\n<h2>启用 SRI</h2>\n<p>使用 SRI 只需要给页面标签添加 integrity 属性，属性值为签名算法（sha256、sha384、sha512）和摘要签名内容组成，中间用 - 分隔。</p>\n<p><img src=\"https://user-images.githubusercontent.com/10385585/104551589-201d8c80-5672-11eb-9eec-bbca5dad8345.png\" alt=\"sri\"></p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2dca549ae983847978\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2dca549ae983847978-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2dca549ae983847978-2\" style=\"height: 40px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2dca549ae983847978-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2dca549ae983847978-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2dca549ae983847978-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2dca549ae983847978-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2dca549ae983847978-7\" style=\"height: 40px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2dca549ae983847978-8\" style=\"height: 20px;\">8</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2dca549ae983847978-1\"><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getIntegrity</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2dca549ae983847978-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">hashFuncName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'sha256'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2dca549ae983847978-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hash</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">crypto</span></div><div class=\"crayon-line\" id=\"crayon-649c2dca549ae983847978-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">createHash</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hashFuncName</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-649c2dca549ae983847978-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">update</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">source</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'utf8'</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-649c2dca549ae983847978-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">digest</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'base64'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2dca549ae983847978-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hashFuncName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'-'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hash</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2dca549ae983847978-8\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0024 seconds] -->\n<p></p>\n<p>我们也可以借助 <a href=\"https://www.npmjs.com/package/webpack-subresource-integrity\">webpack-subresource-integrity</a> 轻易实现 integrity 的添加过程，保持对开发者透明。</p>\n<p>开启 SRI，浏览器会对相关资源进行 CORS 校验，所以被加载的资源要么在同域下，要么得满足 CORS 机制（具体方式可查看 <a href=\"https://github.com/joeyguo/blog/issues/13\">脚本错误量极致优化-监控上报与 Script error</a> 中 <strong>跨源资源共享机制 ( CORS )</strong> 章节）。</p>\n<p>至此，当资源内容被劫持篡改时，浏览器校验签名不匹配将使得异常资源不被执行，并触发加载失败。从而进入到资源加载失败的监控流程中，最终可以通过切换 CDN 域名或主域名进行加载重试，直到加载上正确资源，避免资源被劫持篡改内容后注入广告或白屏等情况。</p>\n<h2>监控劫持</h2>\n<p>监控及重加载的具体方式可见 <a href=\"https://github.com/joeyguo/blog/issues/25\">《前端资源加载失败优化》</a>。加载失败的原因有很多，那么该如何区分哪些是由 SRI 机制触发的呢？可以采用下面思路：</p>\n<ol>\n<li>当加载失败时，切换域名重加载到正确资源；</li>\n<li>分别请求加载失败的和最终正常的 URL，抽样对比两份内容是否存在差异，存在则说明内容被篡改，属于 SRI 机制触发。</li>\n</ol>\n<p>最终搭配上报和告警机制，当遇到劫持问题时，及时收到消息。</p>\n<h2>应对劫持</h2>\n<p><img src=\"https://user-images.githubusercontent.com/10385585/104548950-d54d4600-566c-11eb-9f52-4c5f442646a7.png\" alt=\"sri-monitor\"></p>\n<p>上面是我们遇到的劫持问题，上报量急剧上升，处理后快速下降。遇到劫持问题之后，我们该如何应对呢？</p>\n<p>向运营商客服投诉或工信部投诉或许是个办法。不过在此之前我们可以先主动触发刷新 CDN 节点缓存的资源，避免被劫持的资源被继续访问。除此之外，对于已经缓存到异常资源的用户，特别是在不方便强制刷新页面的环境下，下次访问会先接着访问异常缓存造成二次伤害，对此通过修改文件 hash，重新发布强制刷新资源，问题得以解决。</p>\n<h1>CSP（Content Security Policy）</h1>\n<p>资源内容完整（不被篡改）加载下来了，但加载的是否就都是我们需要的资源呢？是否会因为代码问题导致 XSS、或是浏览器使用了异常插件，最终导致加载了其他不需要的资源而影响业务呢？</p>\n<p>对此，我们可以开启 CSP 机制来保证加载的是需要的资源文件、执行的是正常的脚本。</p>\n<p>一方面通过制定 CSP 的外链白名单机制，限制了不可信域名的资源加载；另一方面通过开启 nonce 模式，确保执行的是正常的内联脚本。相关内容可以查看 [<a href=\"https://github.com/joeyguo/blog/issues/5\">《XSS 终结者-CSP 理论与实践》</a>和 <a href=\"https://github.com/joeyguo/blog/issues/24\">《Csp Nonce - 守护你的 inline Script》</a>这两篇文章。</p>\n<h1>总结</h1>\n<p>HTTPS 可以有效应对流量劫持的问题，SRI 在资源完整性再上一道屏障，CSP 也进行了其他方面的补充。“三驾马车” 为页面资源安全 “保驾护航”。当然这也绝非银弹，安全之路充满着荆棘与挑战，任重道远。</p>\n<p>以上为本文所有内容，如有不妥，恳请斧正，谢谢。</p>\n<p><a href=\"https://github.com/joeyguo/blog\">查看更多文章 &gt;&gt;</a><br>\n<a href=\"https://github.com/joeyguo/blog\">https://github.com/joeyguo/blog</a></p>\n\t"
  },
  {
    "id": 4,
    "tags": ["WEB开发"],
    "title": "一个有趣的内存泄漏案例",
    "author": "TAT.SigmaLiu",
    "avatar": "http://www.alloyteam.com/wp-content/uploads/2020/12/1_e62eaf67-820c-49ee-9295-86011d7d596c-1607941296624-43x43.jpg",
    "date": "2020-12-17T16:18:49+00:00",
    "separator": "4562",
    "content": "\n\t\t<h2>0. 背景</h2>\n<p>之前在这篇文章里说过做了个 SSR <a href=\"http://www.alloyteam.com/2020/12/%e8%ae%ba%e5%a6%82%e4%bd%95%e5%83%8f%e7%b4%a0%e7%ba%a7%e7%9b%b4%e5%87%ba%e5%85%b7%e6%9c%8914w%e8%a1%8c%e4%bb%a3%e7%a0%81%e9%87%8f%e7%9a%84%e5%89%8d%e7%ab%af%e9%a1%b5%e9%9d%a2/\">《论如何像素级直出具有 14W 行代码量的前端页面》</a>，本以为今天顺顺利利，高高兴兴。</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/e62eaf67-820c-49ee-9295-86011d7d596c-1607941296624.jpg\" alt=\"e62eaf67-820c-49ee-9295-86011d7d596c\"></p>\n<p>没想到项目放到线上后，随着请求量的增多，却感觉到首屏速度越来越慢，并且是在持续性地变慢。而且在发布完后（也就是容器重建了），耗时又陡然降下来了。</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_52eb633b-73b9-4860-8033-3532e629875e-1607941449590.png\" alt=\"企业微信截图_52eb633b-73b9-4860-8033-3532e629875e\"></p>\n<p><span id=\"more-14928\"></span></p>\n<p>因此很合理地怀疑是内存泄漏了。故而在 STKE 的监控面板瞧一瞧，内存确实是一波一波似浪花。</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_610bd2e0-4488-485e-825a-23be7fd801f5-1607941508783.png\" alt=\"企业微信截图_610bd2e0-4488-485e-825a-23be7fd801f5\"></p>\n<h2>1. 复现问题</h2>\n<p>知道是内存泄漏，我们就需要找到泄漏的点。因为不能轻易操作线上环境，线上代码也是压缩的，因此我们需要先搭建本地环境看能否方便调试问题。这里我们我们可以在本地起 Server 后，写脚本发起请求，来模拟线上环境。（但是看过上篇文章的小伙伴都知道，我们还有个骨架屏的模式，可以跳过发起 CGI 请求的步骤，大大降低单次请求耗时，让这个结果几秒钟就出来了）</p>\n<p>我们可以使用 <code>heapdump</code> 包来将堆栈信息写入本地文件。<code>heapdump</code> 的基本使用姿势是这样的：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dcbb426622276\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcbb426622276-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcbb426622276-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcbb426622276-3\" style=\"height: 40px;\">3</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dcbb426622276-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">heapdump</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'heapdump'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcbb426622276-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcbb426622276-3\"><span class=\"crayon-v\">heapdump</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">writeSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./test.heapsnapshot'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0017 seconds] -->\n<p></p>\n<p>然后就可以将堆栈文件导入到 Chrome 开发者工具的 <code>Memory</code> 栏来分析。这里我选择了分别是运行了 1 次、50 次、100 次 以及等待几秒钟垃圾回收后再写个 101 次的堆栈信息。可以看到堆栈文件越变越大，从 35M 增大到 249M。</p>\n<p>选择两个堆栈文件做比较来分析，这里有个技巧就是按内存大小排序，然后看到同一个大小的对象个数非常多，那么很有可能就是它被引用了很多次，泄漏的点就可能在那里。然后就发现了问题可能出在 <code>console</code> 对象上。</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_f46c874c-b1aa-4a6b-bc72-80cef5acfcdf-1607949392327.png\" alt=\"企业微信截图_f46c874c-b1aa-4a6b-bc72-80cef5acfcdf\"></p>\n<h2>2. 分析问题</h2>\n<p>正常地使用 <code>console</code> 对象不会造成内存泄漏，因此就怀疑是否是对 <code>console</code> 做了什么操作。搜索了一番代码，排除正常调用外，发现有个赋值的操作，就类似于下面这段代码：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dcc3945685773\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc3945685773-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc3945685773-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc3945685773-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc3945685773-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc3945685773-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc3945685773-6\" style=\"height: 20px;\">6</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dcc3945685773-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc3945685773-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc3945685773-3\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc3945685773-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// 省略一些操作</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc3945685773-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc3945685773-6\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0008 seconds] -->\n<p></p>\n<p>这段代码在前端开发中其实是比较常见的，比如需要在 log 中自动添加时间：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dcc6022146194\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc6022146194-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc6022146194-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc6022146194-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc6022146194-4\" style=\"height: 40px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc6022146194-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc6022146194-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc6022146194-7\" style=\"height: 20px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc6022146194-8\" style=\"height: 40px;\">8</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dcc6022146194-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc6022146194-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc6022146194-3\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc6022146194-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Date</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toTimeString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc6022146194-5\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc6022146194-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc6022146194-7\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">error</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Test'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc6022146194-8\"><span class=\"crayon-c\">// [20:58:17 GMT+0800 (中国标准时间)] Test</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0011 seconds] -->\n<p></p>\n<p>还有一个更常见的场景是，我们要在生产环境下屏蔽大部分的 log 输出，但是又要保留一个 log 函数引用，用来有时候在浏览器终端上输出一些关键信息，这时候会这么写：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dcc9709774637\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc9709774637-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc9709774637-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc9709774637-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc9709774637-4\" style=\"height: 40px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc9709774637-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc9709774637-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcc9709774637-7\" style=\"height: 40px;\">7</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dcc9709774637-1\"><span class=\"crayon-c\">// 引用，用来有时候在需要的时候上报</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc9709774637-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">logger</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">log</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc9709774637-3\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc9709774637-4\"><span class=\"crayon-c\">// 必需用函数赋值，原有的一大堆使用 console.log('...') 的地方才不会报错</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc9709774637-5\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">log</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc9709774637-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcc9709774637-7\"><span class=\"crayon-e\">logger</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'浏览器终端 AlloyTeam 招聘信息'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0007 seconds] -->\n<p></p>\n<p>但是在我们的环境下，原来客户端的代码是被编译后放在 vm 里反复运行的，这会带来什么问题呢？</p>\n<p>这里附个代码，感兴趣的小伙伴可以跑一下：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dccc622060485\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-2\" style=\"height: 40px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-6\" style=\"height: 40px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-7\" style=\"height: 60px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-8\" style=\"height: 20px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-9\" style=\"height: 20px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-10\" style=\"height: 20px;\">10</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-11\" style=\"height: 40px;\">11</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-12\" style=\"height: 20px;\">12</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-13\" style=\"height: 40px;\">13</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-14\" style=\"height: 20px;\">14</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-15\" style=\"height: 20px;\">15</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-16\" style=\"height: 20px;\">16</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-17\" style=\"height: 20px;\">17</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-18\" style=\"height: 40px;\">18</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-19\" style=\"height: 20px;\">19</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-20\" style=\"height: 40px;\">20</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-21\" style=\"height: 20px;\">21</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-22\" style=\"height: 20px;\">22</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-23\" style=\"height: 20px;\">23</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-24\" style=\"height: 20px;\">24</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-25\" style=\"height: 40px;\">25</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-26\" style=\"height: 20px;\">26</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-27\" style=\"height: 20px;\">27</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-28\" style=\"height: 20px;\">28</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-29\" style=\"height: 40px;\">29</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-30\" style=\"height: 20px;\">30</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-31\" style=\"height: 20px;\">31</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-32\" style=\"height: 20px;\">32</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-33\" style=\"height: 20px;\">33</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-34\" style=\"height: 20px;\">34</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-35\" style=\"height: 20px;\">35</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-36\" style=\"height: 20px;\">36</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-37\" style=\"height: 20px;\">37</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dccc622060485-38\" style=\"height: 20px;\">38</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'vm'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">heapdump</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'heapdump'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-3\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-4\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">5000</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-5\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-6\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">writeSnapshot</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">heapdump</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">writeSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">}</span><span class=\"crayon-o\">-</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">heapsnapshot</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-8\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-9\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-10\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">code</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-12\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-16\"><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-17\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-18\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">script</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Script</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">code</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-19\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-20\"><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">let</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">script</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">runInNewContext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-24\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">}</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-26\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">switch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">case</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">case</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Math</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">floor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0.5</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">case</span><span class=\"crayon-v\"> total:</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">writeSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-33\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-34\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-35\"><span class=\"crayon-r\">setTimeout</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">writeSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-37\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3000</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dccc622060485-38\">&nbsp;</div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0042 seconds] -->\n<p></p>\n<p>很小一段代码，运行 5000 次后内存占用到了 1G 多，并且还没有回收的迹象。</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201214221512498-1607955313304.png\" alt=\"image-20201214221512498\"></p>\n<p>我们先来考虑在 vm 的环境下，差异点在于：</p>\n<ol>\n<li>vm 里是没有 console 对象的，vm 里的 console 对象是宿主环境传递进去的，在 vm 里针对 console 的修改，也会反映在宿主环境的 console 对象上；</li>\n<li>在同一段代码多次执行的情况下，也就意味着这几次执行环境是共享 console 对象的，而在浏览器环境下，刷新页面后，代码被多次执行，环境都是独立的；</li>\n</ol>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201214210347505-1607951027663.png\" alt=\"image-20201214210347505\"></p>\n<p>那么我们的问题就会出现如上图所示：</p>\n<ol>\n<li>在宿主环境上，<code>console.error</code> 原来指向的是原生的 error 方法；</li>\n<li>在 vm 第一次执行的时候（假设这个过程要赋值的函数是 Func1），先是引用了 <code>console.error</code> ，也就是引用了原生的 error 方法，同时通过赋值操作将宿主环境上的 <code>console.error</code> 指向了 Func1；</li>\n<li>在 vm 第二次执行的时候，也是先引用了 <code>console.error</code> 方法，但是引用到的已经是第 2 步设置的 Func1，也就是 Func2 引用了 Func1。同时它又将宿主环境上的 <code>console.error</code> 设置成了 Func2；</li>\n<li>同理，Func3 引用了 Func2，并且 <code>console.error</code> 指向了 Func3；</li>\n</ol>\n<p>所以聪明的小伙伴们发现问题没有，这变成了一个链式引用。这条链上的对象一个都别想被回收，都被牢牢绑死了。</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/a8bfc34b-3a3a-4db7-9eba-b848ea1fb271-1607951731984.gif\" alt=\"a8bfc34b-3a3a-4db7-9eba-b848ea1fb271\"></p>\n<p>如果我们要解决这个问题，理想的引用模型应该是什么样的呢？</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201214211632116-1607951792282.png\" alt=\"image-20201214211632116\"></p>\n<p>理想的一个引用模型应该是无论 vm 代码被执行了多少次，在我们取值和赋值操作应该做到：</p>\n<ol>\n<li>取值操作始终取的是原生的 error 方法，因为如果取到了上次运行赋值的方法，那么就会存在引用关系；</li>\n<li>赋值操作将不能操作到宿主环境的 console 对象，因为这样将会影响到其他批次 vm 里的全局 console 对象；</li>\n<li>赋值操作后的取值操作将需要取到赋值后的方法，这样才能执行到自定义的逻辑；</li>\n</ol>\n<p>这其实就要求我们不仅对 vm 的上下文做隔离，对 vm 创建的上下文所传递的属于宿主环境的引用对象也要做隔离。</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/4d700f16-5901-49f5-aeba-93030ffd39eb-1607952450941.jpg\" alt=\"4d700f16-5901-49f5-aeba-93030ffd39eb\"></p>\n<h2>3. 解决问题</h2>\n<p>有什么简单的解决办法吗？假设我们很清楚的认识到代码执行环境（多次执行且共享宿主对象），那么只需要做个标志位防止多次执行就可以了：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dcd0998284140\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd0998284140-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd0998284140-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd0998284140-3\" style=\"height: 40px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd0998284140-4\" style=\"height: 40px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd0998284140-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd0998284140-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd0998284140-7\" style=\"height: 40px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd0998284140-8\" style=\"height: 20px;\">8</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dcd0998284140-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd0998284140-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd0998284140-3\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">hasBeenRewrite</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd0998284140-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd0998284140-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd0998284140-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd0998284140-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">hasBeenRewrite</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd0998284140-8\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0011 seconds] -->\n<p></p>\n<p>但是在原来运行于客户端的代码里会这么写的，感觉要么是已经遭遇过了这个问题，要么只能说优秀，一开始就有了这个意识！</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/805fe1d5-43a8-4666-a200-abd342020feb-1607953102829.gif\" alt=\"805fe1d5-43a8-4666-a200-abd342020feb\"></p>\n<p>那么当我们要做一个基础运行库的时候，可以做到不需要业务关心这么细的问题吗？也就是我们可能对对象隔离出上下文环境里的上下文环境吗？有这么几个条件是支持我们这么做的：</p>\n<ol>\n<li>我们传递到 vm 里属于宿主环境的引用对象其实很有限，因此可以对这么几个有限的对象做隔离；</li>\n<li>我们需要隔离的对象是跟随着 vm 创建的上下文的；</li>\n</ol>\n<p>那么回到我们上文提到的理想模型，这里先附上代码，再来对整个方案做解读：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dcd3688492260\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-2\" style=\"height: 40px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-6\" style=\"height: 40px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-7\" style=\"height: 60px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-8\" style=\"height: 20px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-9\" style=\"height: 20px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-10\" style=\"height: 20px;\">10</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-11\" style=\"height: 40px;\">11</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-12\" style=\"height: 20px;\">12</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-13\" style=\"height: 40px;\">13</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-14\" style=\"height: 20px;\">14</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-15\" style=\"height: 20px;\">15</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-16\" style=\"height: 20px;\">16</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-17\" style=\"height: 20px;\">17</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-18\" style=\"height: 40px;\">18</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-19\" style=\"height: 20px;\">19</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-20\" style=\"height: 40px;\">20</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-21\" style=\"height: 20px;\">21</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-22\" style=\"height: 20px;\">22</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-23\" style=\"height: 40px;\">23</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-24\" style=\"height: 40px;\">24</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-25\" style=\"height: 40px;\">25</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-26\" style=\"height: 40px;\">26</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-27\" style=\"height: 20px;\">27</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-28\" style=\"height: 20px;\">28</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-29\" style=\"height: 40px;\">29</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-30\" style=\"height: 20px;\">30</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-31\" style=\"height: 40px;\">31</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-32\" style=\"height: 40px;\">32</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-33\" style=\"height: 40px;\">33</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-34\" style=\"height: 20px;\">34</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-35\" style=\"height: 20px;\">35</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-36\" style=\"height: 40px;\">36</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-37\" style=\"height: 60px;\">37</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-38\" style=\"height: 40px;\">38</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-39\" style=\"height: 20px;\">39</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-40\" style=\"height: 20px;\">40</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-41\" style=\"height: 20px;\">41</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-42\" style=\"height: 20px;\">42</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-43\" style=\"height: 20px;\">43</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-44\" style=\"height: 40px;\">44</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-45\" style=\"height: 20px;\">45</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-46\" style=\"height: 20px;\">46</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-47\" style=\"height: 20px;\">47</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-48\" style=\"height: 40px;\">48</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-49\" style=\"height: 40px;\">49</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-50\" style=\"height: 20px;\">50</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-51\" style=\"height: 40px;\">51</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-52\" style=\"height: 20px;\">52</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-53\" style=\"height: 40px;\">53</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-54\" style=\"height: 20px;\">54</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-55\" style=\"height: 20px;\">55</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-56\" style=\"height: 20px;\">56</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-57\" style=\"height: 40px;\">57</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-58\" style=\"height: 20px;\">58</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-59\" style=\"height: 20px;\">59</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-60\" style=\"height: 20px;\">60</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-61\" style=\"height: 20px;\">61</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-62\" style=\"height: 20px;\">62</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-63\" style=\"height: 20px;\">63</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-64\" style=\"height: 20px;\">64</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-65\" style=\"height: 20px;\">65</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd3688492260-66\" style=\"height: 20px;\">66</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'vm'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">heapdump</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'heapdump'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-3\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-4\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">5000</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-5\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-6\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">writeSnapshot</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">heapdump</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">writeSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">}</span><span class=\"crayon-o\">-</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">heapsnapshot</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-8\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-9\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-10\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">code</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-12\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-16\"><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-17\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-18\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">script</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Script</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">code</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-19\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-20\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vmProxy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-22\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyObj</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Proxy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">get</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-28\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">set</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-35\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">defineObj</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">typeof</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'function'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">typeof</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'object'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">defineObj</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-41\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-42\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-43\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyObj</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-44\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-46\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-47\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-48\"><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">let</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">context</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">vmProxy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'console'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-50\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-51\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">script</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">runInNewContext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-52\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-53\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">}</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-54\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-55\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">switch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-56\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">case</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-57\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">case</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Math</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">floor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0.5</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-58\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">case</span><span class=\"crayon-v\"> total:</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-59\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">writeSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-60\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-61\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-62\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-63\"><span class=\"crayon-r\">setTimeout</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-64\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">writeSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-65\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3000</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd3688492260-66\">&nbsp;</div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0085 seconds] -->\n<p></p>\n<p>这里有几个关键的点：</p>\n<ol>\n<li>用 <code>Proxy</code> 方法，对 console 的属性 get 操作做拦截；</li>\n<li>我们将在 vm 上下文对象上设置 <code>proxyStore</code> 对象用来存储 set 操作设置的值，这个 <code>proxyStore</code> 将跟随着上下文的回收而回收；</li>\n<li>对 console 的 set 操作将不会设置到 console 上而影响宿主环境的引用对象，但是又需要做存储；</li>\n</ol>\n<p>分步骤来看：</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201214232739820-1607959660026.png\" alt=\"image-20201214232739820\"></p>\n<ol>\n<li>对 <code>console.error</code> 的取值操作，我们判断 ProxyStore 里是否被当前环境设置过了，这时候没有，那么我们给取值操作返回原生的 error 方法；</li>\n</ol>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201214220400124-1607954640313.png\" alt=\"image-20201214220400124\"></p>\n<ol start=\"2\">\n<li>对 <code>console.error</code> 赋值 Func1 的操作，我们判断 ProxyStore 里没有存储对这个属性的赋值，那么将 Func1 存储到 ProxyStore，这里注意我们不能将 Func1 设置到 <code>console.error</code> 上；</li>\n</ol>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201215013421186-1607967261392.png\" alt=\"image-20201215013421186\"></p>\n<ol start=\"3\">\n<li>在后续的调用 <code>console.error</code> 操作，又会被我们拦截 get 方法，我们判断到 ProxyStore 里有被赋值过 Func1，这时候返回 Func1，调用 <code>console.error</code> 就变成了调用 <code>Func1</code> ；</li>\n</ol>\n<p>通过以上的操作，我们维持了 <code>console.error</code> 始终指向原生 error 方法，每次的引用也都是引用的原生的 error 方法，而不是上一次设置的方法。</p>\n<p>然后我们就解决了这个内存泄漏的问题：</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201214221751724-1607955471906.png\" alt=\"image-20201214221751724\"></p>\n<h2>4. 规避问题</h2>\n<p>用这么个聪明的方法解决了这个问题，貌似都有点欣赏自己了呢。</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/db59b6b7-fd71-4bc9-a504-531803db931b-1607955588440.jpg\" alt=\"db59b6b7-fd71-4bc9-a504-531803db931b\"></p>\n<p>但是我们再来考虑 <code>Proxy</code> 会带来什么问题，会有性能问题吗？</p>\n<p>实践出真知，我们对比上面两种解决方法的性能差异：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dcd9938968981\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-5\" style=\"height: 40px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-7\" style=\"height: 20px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-8\" style=\"height: 40px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-9\" style=\"height: 40px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-10\" style=\"height: 40px;\">10</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-11\" style=\"height: 40px;\">11</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-12\" style=\"height: 20px;\">12</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-13\" style=\"height: 20px;\">13</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-14\" style=\"height: 40px;\">14</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-15\" style=\"height: 20px;\">15</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-16\" style=\"height: 40px;\">16</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-17\" style=\"height: 40px;\">17</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-18\" style=\"height: 40px;\">18</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-19\" style=\"height: 20px;\">19</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-20\" style=\"height: 20px;\">20</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-21\" style=\"height: 40px;\">21</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-22\" style=\"height: 60px;\">22</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-23\" style=\"height: 40px;\">23</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-24\" style=\"height: 20px;\">24</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-25\" style=\"height: 20px;\">25</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-26\" style=\"height: 20px;\">26</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-27\" style=\"height: 20px;\">27</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-28\" style=\"height: 20px;\">28</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-29\" style=\"height: 40px;\">29</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-30\" style=\"height: 20px;\">30</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-31\" style=\"height: 20px;\">31</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-32\" style=\"height: 20px;\">32</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-33\" style=\"height: 20px;\">33</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-34\" style=\"height: 20px;\">34</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-35\" style=\"height: 40px;\">35</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-36\" style=\"height: 20px;\">36</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-37\" style=\"height: 40px;\">37</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-38\" style=\"height: 40px;\">38</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-39\" style=\"height: 20px;\">39</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-40\" style=\"height: 20px;\">40</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-41\" style=\"height: 20px;\">41</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-42\" style=\"height: 40px;\">42</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-43\" style=\"height: 20px;\">43</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-44\" style=\"height: 20px;\">44</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-45\" style=\"height: 40px;\">45</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-46\" style=\"height: 40px;\">46</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-47\" style=\"height: 20px;\">47</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-48\" style=\"height: 40px;\">48</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-49\" style=\"height: 20px;\">49</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-50\" style=\"height: 20px;\">50</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-51\" style=\"height: 20px;\">51</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-52\" style=\"height: 20px;\">52</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-53\" style=\"height: 20px;\">53</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-54\" style=\"height: 20px;\">54</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-55\" style=\"height: 40px;\">55</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-56\" style=\"height: 20px;\">56</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-57\" style=\"height: 40px;\">57</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-58\" style=\"height: 40px;\">58</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-59\" style=\"height: 40px;\">59</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-60\" style=\"height: 20px;\">60</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-61\" style=\"height: 40px;\">61</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-62\" style=\"height: 20px;\">62</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-63\" style=\"height: 20px;\">63</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-64\" style=\"height: 20px;\">64</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-65\" style=\"height: 40px;\">65</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-66\" style=\"height: 20px;\">66</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-67\" style=\"height: 20px;\">67</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-68\" style=\"height: 40px;\">68</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-69\" style=\"height: 20px;\">69</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-70\" style=\"height: 20px;\">70</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-71\" style=\"height: 20px;\">71</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-72\" style=\"height: 20px;\">72</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-73\" style=\"height: 20px;\">73</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-74\" style=\"height: 20px;\">74</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcd9938968981-75\" style=\"height: 20px;\">75</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'vm'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-3\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">10000</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-5\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vmProxy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-7\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyObj</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Proxy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">get</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-13\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">set</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-20\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">defineObj</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">typeof</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'function'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">typeof</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'object'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">defineObj</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-27\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyObj</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyStore</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-31\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-32\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-33\"><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">code</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-36\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-41\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-42\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">script</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Script</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">code</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-43\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-44\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">time</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'proxy'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">let</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-46\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">context</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">vmProxy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'console'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-47\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">script</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">runInNewContext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-50\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">timeEnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'proxy'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-51\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-52\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-53\"><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-54\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">let </span><span class=\"crayon-v\">code</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-55\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-56\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-57\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">hasBeenRewrite</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-58\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-59\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-60\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-61\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">hasBeenRewrite</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-62\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-63\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-64\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-65\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">let </span><span class=\"crayon-v\">script</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Script</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">code</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-66\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-67\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">time</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'flag'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-68\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">let</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-69\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">script</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">runInNewContext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-70\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-71\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-72\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-73\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">timeEnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'flag'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-74\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcd9938968981-75\">&nbsp;</div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0089 seconds] -->\n<p></p>\n<p>看起来几乎没什么性能差异</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201214223335486-1607956416304.png\" alt=\"image-20201214223335486\"></p>\n<p>但是 <code>Proxy</code> 有个 <code>this</code> 指向的问题，因为 <code>Proxy</code> 不是个透明代理，被 <code>Proxy</code> 代理的对象内部的 this 指向会指向 proxy 实例，因此如果是这么个简单例子还好，但是放到线上代理比较复杂的对象，心里还是毛毛的。（还需要考虑对象里的对象）</p>\n<p>有没有可能在开发阶段就能发现类似的内存泄漏问题，而不是等到发布线上才发现呢？</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/u%3D4273372014%2C11074410%26fm%3D26%26gp%3D0-1607956761688.jpg\" alt=\"img\"></p>\n<p>当然是想到了办法我才会说了，之前想这个问题的时候想了一下午，想得太复杂了，所以试了好多种方法也没有想出来。我们先来澄清一点，这里是因为要赋值的函数里又调用了存储的 <code>nativeError</code> 吗？其实是无关的，即使你将 <code>nativeError(...argv)</code> 注释掉，仍然是会存在内存泄漏的问题。</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dcdd755645822\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcdd755645822-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcdd755645822-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcdd755645822-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcdd755645822-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dcdd755645822-5\" style=\"height: 20px;\">5</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dcdd755645822-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcdd755645822-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dcdd755645822-3\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcdd755645822-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dcdd755645822-5\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0007 seconds] -->\n<p></p>\n<p>这里的原因在于只要同一个 vm 虚拟机里对宿主环境的引用对象的同一个 key 同时做 <code>get</code> 和 <code>set</code> 操作，那么就会存在内存泄漏。我们来考虑下面这三种情况是否会存在内存泄漏：</p>\n<p>相同的 key：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dce0584411987\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce0584411987-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce0584411987-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce0584411987-3\" style=\"height: 40px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce0584411987-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce0584411987-5\" style=\"height: 20px;\">5</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dce0584411987-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">undefined</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce0584411987-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce0584411987-3\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">undefined</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce0584411987-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce0584411987-5\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0007 seconds] -->\n<p></p>\n<p>不同的 key:</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dce3749328832\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce3749328832-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce3749328832-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce3749328832-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce3749328832-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce3749328832-5\" style=\"height: 20px;\">5</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dce3749328832-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">undefined</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce3749328832-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce3749328832-3\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">notExist</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce3749328832-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nativeError</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce3749328832-5\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0007 seconds] -->\n<p></p>\n<p>设置的不是引用对象：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dce5932052745\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce5932052745-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce5932052745-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce5932052745-3\" style=\"height: 20px;\">3</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dce5932052745-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce5932052745-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce5932052745-3\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e \">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'AlloyTeam'</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0004 seconds] -->\n<p></p>\n<p>答案是第一个会存在内存泄漏，第二和第三不会。好奇的小伙伴可以用上面的例子代码跑一下。</p>\n<p>我们将这个问题简化了，再来看检测的方案，照例先上代码：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e065dce8927378704\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-1\" style=\"height: 60px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-7\" style=\"height: 80px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-8\" style=\"height: 20px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-9\" style=\"height: 40px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-10\" style=\"height: 40px;\">10</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-11\" style=\"height: 40px;\">11</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-12\" style=\"height: 40px;\">12</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-13\" style=\"height: 20px;\">13</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-14\" style=\"height: 40px;\">14</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-15\" style=\"height: 40px;\">15</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-16\" style=\"height: 20px;\">16</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-17\" style=\"height: 40px;\">17</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-18\" style=\"height: 40px;\">18</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-19\" style=\"height: 40px;\">19</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-20\" style=\"height: 20px;\">20</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-21\" style=\"height: 20px;\">21</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-22\" style=\"height: 20px;\">22</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-23\" style=\"height: 20px;\">23</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-24\" style=\"height: 40px;\">24</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-25\" style=\"height: 60px;\">25</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-26\" style=\"height: 40px;\">26</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-27\" style=\"height: 20px;\">27</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-28\" style=\"height: 20px;\">28</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-29\" style=\"height: 40px;\">29</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-30\" style=\"height: 20px;\">30</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-31\" style=\"height: 20px;\">31</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-32\" style=\"height: 20px;\">32</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-33\" style=\"height: 20px;\">33</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-34\" style=\"height: 20px;\">34</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-35\" style=\"height: 20px;\">35</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-36\" style=\"height: 20px;\">36</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-37\" style=\"height: 20px;\">37</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-38\" style=\"height: 40px;\">38</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-39\" style=\"height: 20px;\">39</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-40\" style=\"height: 20px;\">40</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-41\" style=\"height: 40px;\">41</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-42\" style=\"height: 20px;\">42</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-43\" style=\"height: 20px;\">43</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-44\" style=\"height: 20px;\">44</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-45\" style=\"height: 40px;\">45</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-46\" style=\"height: 20px;\">46</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-47\" style=\"height: 20px;\">47</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-48\" style=\"height: 40px;\">48</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-49\" style=\"height: 20px;\">49</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-50\" style=\"height: 20px;\">50</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-51\" style=\"height: 20px;\">51</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-52\" style=\"height: 40px;\">52</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-53\" style=\"height: 20px;\">53</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-54\" style=\"height: 20px;\">54</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-55\" style=\"height: 20px;\">55</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-56\" style=\"height: 20px;\">56</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-57\" style=\"height: 20px;\">57</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-58\" style=\"height: 20px;\">58</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-59\" style=\"height: 40px;\">59</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-60\" style=\"height: 20px;\">60</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-61\" style=\"height: 20px;\">61</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-62\" style=\"height: 40px;\">62</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-63\" style=\"height: 20px;\">63</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-64\" style=\"height: 20px;\">64</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-65\" style=\"height: 20px;\">65</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-66\" style=\"height: 40px;\">66</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-67\" style=\"height: 20px;\">67</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-68\" style=\"height: 20px;\">68</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-69\" style=\"height: 40px;\">69</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-70\" style=\"height: 20px;\">70</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-71\" style=\"height: 20px;\">71</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-72\" style=\"height: 20px;\">72</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-73\" style=\"height: 20px;\">73</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-74\" style=\"height: 20px;\">74</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-75\" style=\"height: 40px;\">75</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-76\" style=\"height: 20px;\">76</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-77\" style=\"height: 40px;\">77</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-78\" style=\"height: 20px;\">78</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-79\" style=\"height: 20px;\">79</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-80\" style=\"height: 20px;\">80</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-81\" style=\"height: 40px;\">81</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-82\" style=\"height: 20px;\">82</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-83\" style=\"height: 40px;\">83</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-84\" style=\"height: 20px;\">84</div><div class=\"crayon-num\" data-line=\"crayon-649c2e065dce8927378704-85\" style=\"height: 20px;\">85</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">workerData</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Worker</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">isMainThread</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'worker_threads'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'vm'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-3\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">log</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">log</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-5\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">memoryCheckStore</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-7\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">isReferenced</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">typeof</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'object'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">typeof</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'function'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-9\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vmProxy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyObj</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Proxy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">get</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">propValue</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-13\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">memoryCheckStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">memoryCheckStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// todo: 需要处理数组和迭代子对象</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">memoryCheckStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">memoryCheckStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-21\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">propValue</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">set</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">isReferenced</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">memoryCheckStore</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Error</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'[警告] 可能存在内存泄漏'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-28\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">propKey</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-32\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">[</span><span class=\"crayon-r\">name</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">proxyObj</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-35\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-36\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-37\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">code1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">undefined</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-39\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// 泄漏</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-41\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">undefined</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-42\"><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-43\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-44\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">code2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">undefined</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-46\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-47\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// 不会泄漏</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">notExist</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-49\"><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-50\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-51\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">code3</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-52\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">undefined</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-53\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-54\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// 不会泄漏</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-55\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e \">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'AlloyTeam'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-56\"><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-57\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-58\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">code4</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-59\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nativeError</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-60\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-61\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// 泄漏</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-62\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-63\"><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-64\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-65\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">isMainThread</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-66\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">let</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-67\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Worker</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">__filename</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-68\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">workerData</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-69\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">code</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">eval</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-e\">code</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-70\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">flag</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-71\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-72\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-73\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-74\"><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-75\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">code</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">flag</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">workerData</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-76\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-77\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">script</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Script</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">code</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-78\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">filename</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-e\">code</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">flag</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-79\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-80\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-81\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">context</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">vmProxy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'console'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-82\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-83\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">script</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">runInNewContext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-84\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e065dce8927378704-85\">&nbsp;</div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0097 seconds] -->\n<p></p>\n<p>仅一次运行，就知道 code1、code4 可能存在内存泄漏：</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201215010141463-1607965301665.png\" alt=\"image-20201215010141463\"></p>\n<p>方案图解 1，get 阶段：</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201215010230874-1607965351084.png\" alt=\"image-20201215010230874\"></p>\n<ol>\n<li>一开始 <code>console.error</code> 指向原生的 error 方法；</li>\n<li>我们在全局设置个 GlobalGetStore 对象，用来记录被引用的对象和被引用的属性名；</li>\n<li>第一次运行，拦截的 get 方法里判断 store 里没有这个对象，就记录对象到 store，同时也记录被引用的 key 值；</li>\n</ol>\n<p>方案图解 2，set 阶段：</p>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201215010413865-1607965454075.png\" alt=\"image-20201215010413865\"></p>\n<ol>\n<li>拦截的 set 方法里判断了 store 里已经有存储了被引用的对象，同时当次操作的 key 值也已经被引用过了，因此判定在 vm 这样多次执行的环境里，可能存在内存泄漏，打印出告警信息；</li>\n</ol>\n<p>这样我们就可以在开发阶段部署这样内存检测代码（demo 代码仍然需要处理数组和对象属性是引用类型的情况），在生产环境上移除或失效。</p>\n<p>当然了，一个较优秀的项目，上线前后仍然有两件相关的事情可以做：</p>\n<ol>\n<li>自动化测试，通过模拟发起多个用户请求，检测内存变化，上线前检测到可能的内存泄漏；</li>\n<li>设置告警策略，在内存超限时告警，查看内存变化，确认是否泄漏；</li>\n</ol>\n<p><img src=\"https://typro-img-1256878004.cos.ap-nanjing.myqcloud.com/image-20201214225924565-1607957964807.png\" alt=\"image-20201214225924565\"></p>\n<h2>5. 后记</h2>\n<p>遇到这样一个问题，其实还挺有趣的，虽然是一个小点，但是梳理了一个比较完整的思考过程，希望能对小伙伴们解决相关问题带来参考和想法。</p>\n<p>我们是在做腾讯文档的 AlloyTeam，欢迎有技术想法的小伙伴来撩~</p>\n\t"
  },
  {
    "id": 5,
    "tags": ["JavaScript", "WEB开发"],
    "title": "编译的速度与激情：从 10mins 到 1s",
    "author": "TAT.glendon",
    "avatar": "https://secure.gravatar.com/avatar/b68d48472c479dff6d0994fb07a4ff6b?s=43",
    "date": "2020-12-14T18:06:07+00:00",
    "separator": "6537",
    "content": "\n\t\t<h1>编译的速度与激情：从 10mins 到 1s</h1>\n<blockquote>\n<p>导语：对于大型前端项目而言，构建的稳定性和易用性至关重要，腾讯文档在迭代过程中，复杂的项目结构和编译带来的问题日益增多，极大的增加了新人上手与日常搬砖的开销。恰逢 Webpack5 上线，不如来一次彻底的魔改～</p>\n</blockquote>\n<p><span id=\"more-14882\"></span></p>\n<h2>1. 前言</h2>\n<p>腾讯文档最近基于刚刚发布的 Webpack5 进行了一次编译的大重构，作为一个多个仓库共同构成的大型项目，任意品类的代码量都超过百万。对于腾讯文档这样一个快速迭代，高度依赖自动化流水线，常年并行多个大型需求和无数小需求的项目来说，稳定且快速的编译对于开发效率至关重要。这篇文章，就是笔者最近进行重构，成功将日常开发优化到 1s 的过程中，遇到的一些大型项目特有的问题和思考，希望能给大家在前端项目构建的优化中带来一些参考和启发。</p>\n<h2>2. 大型项目编译之痛</h2>\n<p>随着项目体系的逐渐扩大，往往会遇到旧的编译配置无法支持新特性，由于各种 config 文件自带的阅读 debuff，以及累累的技术债，大家总会趋于不去修改旧配置，而是试图新增一些配置在外围对编译系统进行修正。也是这样类似的原因，腾讯文档过去的编译编译也并不优雅：</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-01.png\" alt=\"\" width=\"100%\" class=\"aligncenter size-full wp-image-14888\"></div>\n<p>多级的子仓库结构，复杂的编译系统造成很高的理解和改动成本，也带来了较高的编译耗时，对于整个团队的开发效率有着不小的影响。</p>\n<h2>3.All in One</h2>\n<p>为了解决编译复杂和缓慢的问题，至关重要的，就是禁止套娃：多层级混合的系统必须废除，统一的编译才是王道。在所有编译系统中，Webpack 在大项目的打包上具备很强优势，插件系统最为丰满，并且 Webpack5 的带来了 Module Federation 新特性，因此笔者选择了用 Webpack 来统合多个子仓库的编译。</p>\n<h3 id=\"title-0\">3.1. 整合基于 lerna 的仓库结构</h3>\n<p>腾讯文档使用了 lerna 来管理仓库中的子包，使用 lerna 的好处此处就不作展开了。不过 lerna 的通用用法也带来了一定的问题，lerna 将一个仓库变成了结构上的多个仓库，如果按照默认的使用方式，每个仓库都会有自己的编译配置，单个项目的编译变成了多个项目的联编联调，修改配置和增量优化都会变得比较困难。</p>\n<p>虽然使用 lerna 的目的是使各个子包相对独立，但是在整个项目的编译调试中，往往需要的是所有包的集合，那么，笔者就可以忽略掉这个子包间的物理隔离，把子仓库作为子目录来看待。不依赖 lerna，笔者需要解决的，是子包间的引用问题：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805e7a832533727\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e7a832533727-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e7a832533727-2\" style=\"height: 40px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e7a832533727-3\" style=\"height: 20px;\">3</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805e7a832533727-1\"><span class=\"crayon-c\">/** package/layout/src/xxx.ts **/</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e7a832533727-2\"><span class=\"crayon-e\">import</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Stream</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'@core/model'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e7a832533727-3\"><span class=\"crayon-c\">// do something</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0017 seconds] -->\n<p></p>\n<p>事实上，笔者可以通过 webpack 配置中 resolve 的 alias 属性来达到相应效果：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805e83416480248\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e83416480248-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e83416480248-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e83416480248-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e83416480248-4\" style=\"height: 40px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e83416480248-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e83416480248-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e83416480248-7\" style=\"height: 20px;\">7</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805e83416480248-1\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e83416480248-2\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">resolve</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e83416480248-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">alias</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e83416480248-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'@core/model'</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'word/package/model/src/'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e83416480248-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e83416480248-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e83416480248-7\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0005 seconds] -->\n<p></p>\n<h3 id=\"title-1\">3.2. 管理游离于打包系统之外的文件</h3>\n<p>在大型项目中，有时会存在一些特殊的静态代码文件，它们往往并不参与到打包系统中，而是由其他方式直接引入 html，或者合并到最终的结果中。</p>\n<p>这样的文件，一般分为如下几类：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-02.png\" alt=\"\" width=\"945\" height=\"239\" class=\"aligncenter size-full wp-image-14889\"></p>\n<ol>\n<li>加载时机较早的外部 sdk 文件，本身以 minify 文件提供</li>\n<li>外部文件依赖的其他框架文件，比如 jquery</li>\n<li>一些 polyfill</li>\n<li>一些特殊的必须早期运行的独立逻辑，比如初始化 sdk 等</li>\n</ol>\n<p>由于 polyfill 和外部 sdk 往往直接通过挂全局变量运行的模式，项目中往往会通过直接写入 html script 标签的方式引用它们。不过，随着此类文件的增多，直接利用标签引用，对于版本管理和编译流程都不友好，它们对应的一些初始化逻辑，也无法添加到打包流程中来。这种情况，笔者建议手工的创建一个 js 入口文件，对以上文件进行引用，并作为 webpack 的一个入口。如此，就能通过代码的方式，将这些散装文件管理起来了：</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-03.png\" alt=\"\" class=\"aligncenter size-full wp-image-14890\" style=\"transform: scale(0.75);\"></div>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805e87639005317\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e87639005317-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e87639005317-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e87639005317-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e87639005317-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e87639005317-5\" style=\"height: 20px;\">5</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805e87639005317-1\"><span class=\"crayon-i\">import</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'jquery'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e87639005317-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805e87639005317-3\"><span class=\"crayon-i\">import</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'raven.min.js'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e87639005317-4\"><span class=\"crayon-i\">import</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'log.js'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e87639005317-5\"><span class=\"crayon-c\">// ...</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0004 seconds] -->\n<p></p>\n<p>但是，一些外部的 js 可能依赖于其他 sdk，比如 jQuery，但是打包系统并不知道它们之间的依赖关系，导致 jQuery 没有及时暴露到全局中，该怎么办呢？事实上，webpack 提供了很灵活的方案来处理这些问题，比如，笔者可以通过 expose-loader，将 jQuery 的暴露到全局，供第三方引用。在腾讯文档中，还包含了一些对远程 cdn 的 sdk 组件，这些 sdk 也需要引用一些库，比如 jQuery 的。因此，笔者还通过 splitChunks 的配置，将 jQuery 重新分离出来，放在了较早的加载时机，保证基于 cdn 加载的 sdk 亦能正常初始化。</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-04.png\" alt=\"\" height=\"200\" class=\"aligncenter size-full wp-image-14891\"></div>\n<p>通过代码引用，一方面，可以很好的进行依赖文件的版本管理；另一方面，由于对应文件的编译也加入了打包流程，所有对应文件的改动都可以被动态监视到，有利于后续进行增量编译。同时，由于 webpack 的封装特点，每个库都会被包含在一个 webpack_require 的特殊函数之中，全局变量的暴露数量也变得较为可控。</p>\n<h3 id=\"title-2\">3.3. 定制化的 webpack 流程</h3>\n<p>Webpack 提供了一个非常灵活的 html-webpack-plugin 来进行 html 生成，它支持模板和一众的专属插件，但是，仍然架不住项目有一些特殊的需求，通用的插件配置要么无法满足这些需求，要么适配的结果就十分难懂。这也是腾讯文档在最初使用了 gulp 来生成 html 的原因，在 gulp 配置中，有很多自定义流程来满足腾讯文档的发布要求。</p>\n<p>既然，gulp 可以自定义流程来实现 html 生成，那么，笔者也可以单独写一个 webpack 插件来实现定制的流程。</p>\n<p>Webpack 本身是一个非常灵活的系统，它是一个按照特定的流程执行的框架，在每个流程的不同的阶段提供了不同的钩子，通过各种插件去实现这些钩子的回调，来完成代码的打包，事实上，webpack 本身就是由无数原生插件组成的。在这整个流程中，笔者可以做各种不同的事情来定制它。</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-05.png\" alt=\"\" height=\"320\" class=\"aligncenter size-full wp-image-14892\"></div>\n<p>对于生成 html 的场景，通过增加一个插件，在 webpack 处理生成文件的阶段，将生成的 js、css 等资源文件，以及 ejs 模板和特殊配置整合到一起，再添加到 webpack 的 assets 集合中，便可以完成一次自定义的 html 生成。</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-06.png\" alt=\"\" height=\"300\" class=\"aligncenter size-full wp-image-14893\" style=\"transform: scale(0.75);\"></div>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805e8b332665988\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-2\" style=\"height: 40px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-3\" style=\"height: 40px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-7\" style=\"height: 20px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-8\" style=\"height: 40px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-9\" style=\"height: 20px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-10\" style=\"height: 40px;\">10</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e8b332665988-11\" style=\"height: 20px;\">11</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-1\"><span class=\"crayon-v\">compilation</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">hooks</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">processAssets</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">tap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-2\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'TemplateHtmlEmitPlugin'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-3\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">stage</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Compilation</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">PROCESS_ASSETS_STAGE_ADDITIONAL</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-4\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-5\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// custom generation</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">compilation</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">emitAsset</span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">parsed</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">html</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sources</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">RawSource</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">source</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-9\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-10\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">compilation</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">fileDependencies</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">addAll</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">dependencies</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e8b332665988-11\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0014 seconds] -->\n<p></p>\n<p>在以上代码中，大家可以留意到最后一句：compilation.fileDependencies.addAll(dependencies)，通过这一句，笔者可以将所有被自定义生成所依赖的文件加入的 webpack 的依赖系统中，那么当这些文件发生变更的时候，webpack 能够自动再次触发对应的生成流程。</p>\n<h3 id=\"title-3\">3.4. 一键化的开发体验</h3>\n<p>至此，各路编译都已经统一化，笔者可以用一个 webpack 编译整个项目了，watch 和 devServer 也可以一起 high 起来。不过，既然编译可以统一，何不让所有操作都整合起来呢？</p>\n<p>基于 node_modules 不应该手工操作的假设，笔者可以创建 package.json 中依赖的快照，每次根据 package 的变化来判断是否需要重新安装，避免开发同学同步代码后的手动判断，跳过不必要的步骤。</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805e92770566805\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-2\" style=\"height: 40px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-3\" style=\"height: 40px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-4\" style=\"height: 40px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-6\" style=\"height: 40px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-7\" style=\"height: 20px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-8\" style=\"height: 40px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-9\" style=\"height: 20px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-10\" style=\"height: 60px;\">10</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-11\" style=\"height: 20px;\">11</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-12\" style=\"height: 40px;\">12</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-13\" style=\"height: 20px;\">13</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-14\" style=\"height: 20px;\">14</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-15\" style=\"height: 20px;\">15</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-16\" style=\"height: 20px;\">16</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-17\" style=\"height: 20px;\">17</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-18\" style=\"height: 20px;\">18</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-19\" style=\"height: 20px;\">19</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-20\" style=\"height: 20px;\">20</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-21\" style=\"height: 60px;\">21</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-22\" style=\"height: 40px;\">22</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-23\" style=\"height: 20px;\">23</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-24\" style=\"height: 20px;\">24</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-25\" style=\"height: 20px;\">25</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-26\" style=\"height: 20px;\">26</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-27\" style=\"height: 20px;\">27</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-28\" style=\"height: 40px;\">28</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-29\" style=\"height: 20px;\">29</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-30\" style=\"height: 80px;\">30</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e92770566805-31\" style=\"height: 20px;\">31</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">async </span><span class=\"crayon-e\">install</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">force</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-2\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">startTime</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">performance</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">now</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-3\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">lastSnapshot</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">readSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-4\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">snapshot</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">createSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-5\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">runs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">repoInfos</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">repo</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">isRepoInstallMissing</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">repo</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">repo</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">installed</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">force</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">isEqual</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">snapshot</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">repo</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">lastSnapshot</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">repo</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// create and return install cmd</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">undefined</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-15\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">filter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">script</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">script</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-16\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-17\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">info</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-18\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">runs</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">length</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// 执行安装并保存快照</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">Promise</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">all</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">runs</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">run</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">exec</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">run</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cmd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">run</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">cwd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">run</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">saveSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">snapshot</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">removeSnapshot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">throw</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-27\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">info</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">chalk</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">green</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Skip install'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-29\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-30\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-e\">info</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">chalk</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">bgGreen</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">black</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-e\">Install </span><span class=\"crayon-v\">cost</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">TimeUtil</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">formatTime</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">performance</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">now</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">startTime</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e92770566805-31\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0049 seconds] -->\n<p></p>\n<p>同样的，腾讯文档的本地调试是基于特殊的测试环境，通过 whislte 进行代理，这样的步骤也可以自动化，那么，对于开发来说，一切就很轻松了，一条命令，轻松搬砖~</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-07.png\" alt=\"\" width=\"100%\" class=\"aligncenter size-full wp-image-14894\"></div>\n<p>不过，作为是一个复杂的系统，第一次使用，总需要初始化的吧，如果编译系统的依赖尚未安装，没有鸡，怎么生蛋呢？</p>\n<p>其实不然，笔者不妨在整套编译系统的外层套个娃，做前端开发，node 总会先安装的吧？那么，在执行正在的编译命令之前，笔者执行一个只依赖于 node 的脚本，这个脚本会尝试执行主要命令，如果主命令直接 crash，说明安装环境尚未准备完毕，那么这个时候，对编译系统进行初始化就 ok 了。如此，就真的可以做到一键开发了。</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805e95772451374\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e95772451374-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e95772451374-2\" style=\"height: 80px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e95772451374-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e95772451374-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e95772451374-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e95772451374-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e95772451374-7\" style=\"height: 20px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e95772451374-8\" style=\"height: 20px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e95772451374-9\" style=\"height: 20px;\">9</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805e95772451374-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">cmd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'启动编译的命令'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e95772451374-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">main</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">extraArg</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">childProcess</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">execSync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">cmd</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">extraArg</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">stdio</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'inherit'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cwd</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_</span><span class=\"crayon-sy\">_</span>dirname<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e95772451374-3\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805e95772451374-4\"><span class=\"crayon-st\">try</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e95772451374-5\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">''</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e95772451374-6\"><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e95772451374-7\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// 初始化</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e95772451374-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'after-initialize'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e95772451374-9\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0014 seconds] -->\n<p></p>\n<h3 id=\"title-4\">3.5. 编译系统代码化</h3>\n<p>在这一次的重构过程中，笔者将原本的编译配置改为了由 ts 调用 webpack 的 nodeApi 来执行编译。代码化的编译系统有诸多好处：</p>\n<ol>\n<li>\n<p>使用 api 调用，可以享受 IDE 带来的代码提示，再也不会因为不小心在配置文件里面打了一个 typo 而调试一整天。</p>\n</li>\n<li>\n<p>使用代码 api，能够更好的实现编译的结构，特别是有多重输出的时候，比起简单的 config 文件组合，更好管理。</p>\n</li>\n<li>\n<p>使用代码化的编译系统，还有一个特别的作用，编译系统也可以写测试了！啥？编译系统要写测试？事实上，在腾讯文档历次的发布中，经历过数次莫名的 bug，在上线前的测试中，整个程序的表现突然就不正常了。相关代码，并没有任何改动，大家地毯式的排查了很久，才发现编译的结果和以前有微小的不同。事实上，在系统测试环境生成的前五个小时，一个编译所依赖的插件默默的更新了一个小版本，而笔者在 package.json 中对该插件使用的是默认的^xx.xx，流水线 install 到了最新的版本，导致了 crash。当时笔者得出了一个结论，编译相关的库需要锁定版本。但是，锁定版本并不能真正的解决问题，编译所使用的组件，总有升级的一天，如果保证这个升级不会引起问题呢？这就是自动化测试的范畴了。事实上，如果大家看看 Webpack 的代码，会发现他们也做了很多测试用例来编译的一致性，但是，webpack 的插件五花八门，并不是每一个作者在质量保障上都有足够的投入，因此，用自动化测试保证编译系统的稳定性，也是一个可以深入研究的课题。</p>\n</li>\n</ol>\n<h2>4. 编译提速</h2>\n<p>在涉及 typescript 编译的项目中，基本的提速操作，就是异步的类型检查，ts-loader 的 tranpsileOnly 参数和 fork-ts-checker 的组合拳百试不厌。不过，对于复杂的大型项目来说，这一套组合拳的启用过程未必是一帆风顺，不妨随着笔者一起看看，在腾讯文档中，启用快速编译的坎坷之路。</p>\n<h3 id=\"title-5\">4.1. 消失的 enum</h3>\n<p>在启用 transpileOnly 参数后，编译速度立即有了质的提升，但是，结果并不乐观。编译后，页面还没打开，就 crash 了。根据报错查下去，发现一个从依赖库导入的对象变成了 undefined，从而引起程序崩溃。这个变为 undefined 的对象，是一个 enum，定义如下：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805e9b501489536\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9b501489536-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9b501489536-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9b501489536-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9b501489536-4\" style=\"height: 20px;\">4</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805e9b501489536-1\"><span class=\"crayon-e\">export</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">enumScope</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9b501489536-2\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">VAL1</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9b501489536-3\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">VAL2</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9b501489536-4\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0004 seconds] -->\n<p></p>\n<p>为什么当笔者启用了 transpileOnly 后它就为空了呢？这和它的特殊属性有关，它不是一个普通的 enum，它是一个 const enum。众所周知，枚举是 ts 的语法糖，每一个枚举，对应了 js 中的一个对象，所以，一个普通的枚举，转化为 js 之后，会变成这样：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805e9d752744213\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-7\" style=\"height: 20px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-8\" style=\"height: 20px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-9\" style=\"height: 20px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-10\" style=\"height: 20px;\">10</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-11\" style=\"height: 20px;\">11</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-12\" style=\"height: 20px;\">12</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-13\" style=\"height: 20px;\">13</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-14\" style=\"height: 20px;\">14</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-15\" style=\"height: 20px;\">15</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-16\" style=\"height: 20px;\">16</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805e9d752744213-17\" style=\"height: 20px;\">17</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-1\"><span class=\"crayon-c\">// ts</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-2\"><span class=\"crayon-e\">export</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">enum</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Scope</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-3\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">VAL1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-4\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">VAL2</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-7\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Scope</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">VAL1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-9\"><span class=\"crayon-c\">// js</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-10\"><span class=\"crayon-v\">constScope</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-11\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">VAL1</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-12\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">VAL2</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-13\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'VAL1'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-14\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'VAL2'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-15\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-16\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805e9d752744213-17\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">Scope</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">EDITOR</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0013 seconds] -->\n<p></p>\n<p>如果笔者给 Scope 加上一个 const 关键字呢？它会变成这样：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805ea1860509707\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-7\" style=\"height: 20px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-8\" style=\"height: 20px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-9\" style=\"height: 20px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea1860509707-10\" style=\"height: 20px;\">10</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-1\"><span class=\"crayon-c\">// ts</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-2\"><span class=\"crayon-e\">export</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">enumScope</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-3\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">VAL1</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-4\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">VAL2</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-7\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Scope</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">VAL1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-9\"><span class=\"crayon-c\">// js</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea1860509707-10\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span>；</div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0008 seconds] -->\n<p></p>\n<p>也就是说，const enum 就和宏是等效的，在翻译成 js 之后，它就不存在了。可是，为何在关闭 transpileOnly 时，编译结果可以正常运行呢？其实，仔细翻看外部库的声明文件.d.ts，就会发现，在这个.d.ts 文件中，Scope 被原封不动的保留了下来。</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805ea4099477961\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea4099477961-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea4099477961-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea4099477961-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea4099477961-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea4099477961-5\" style=\"height: 20px;\">5</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805ea4099477961-1\"><span class=\"crayon-c\">// .d.ts</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea4099477961-2\"><span class=\"crayon-e\">export</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">enumScope</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea4099477961-3\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VAL1</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea4099477961-4\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VAL2</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea4099477961-5\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0005 seconds] -->\n<p></p>\n<p>在正常的编译流程下，tsc 会检查.d.ts 文件，并且已经预知了这一个定义，因此，它能够正确的执行宏转换，而对于 transpileOnly 开启的情况下，所有的类型被忽略，由于原本的库模块中已经不存在 Scope 了，所以编译结果无法正常执行（PS：tsc 官方已经表态 transpile 模式下的编译不解析.d.ts 是标准 feature，丢失了 const enum 不属于 bug，所以等待官方支持是无果的）。既然得知了缘由，就可以修复了。四种方案：</p>\n<ul>\n<li>\n<p><strong>方案一</strong>，遵循官方指导，对于不导出 const enum，只对内部使用的枚举 const 化，也就是说，需要修改依赖库。当然，腾讯文档本次 crash 所有依赖库确实属于自有的 sdk，但是如果是外部的库引起了该问题呢？所以该方案并不保险。</p>\n</li>\n<li>\n<p><strong>方案二</strong>，完美版，手动解析.d.ts 文件，寻找所有 const enum 并提取定义。但是，transpileOnly 获取的编译加速真是得益于忽略.d.ts 文件，如果笔者再去为了一个 enum 手工解析.d.ts，而.d.ts 文件可能存在复杂的引用链路，是极其耗时的。</p>\n</li>\n</ul>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-08.png\" alt=\"\" width=\"945\" height=\"147\" class=\"aligncenter size-full wp-image-14895\"></div>\n<ul>\n<li><strong>方案三</strong>，字符串替换，既然 const enum 是宏，那么笔者可以手工通过 string-replace-loader 达到类似效果。不过，字符串替换方式依旧过于暴力，如果使用了类似于 Scope['VAL1'] 的用法，可能就猝不及防的失效了。</li>\n</ul>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-09.png\" alt=\"\" width=\"945\" height=\"172\" class=\"aligncenter size-full wp-image-14896\"></div>\n<ul>\n<li><strong>方案四</strong>，也是笔者最终所采取的方案，既然定义消失了，重新定义就好，通过 Webpack 的 DefinePlugin，笔者可以重新定义丢失的对象，保证编译的正常解析。</li>\n</ul>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805ea7574738859\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea7574738859-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea7574738859-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ea7574738859-3\" style=\"height: 20px;\">3</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805ea7574738859-1\"><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DefinePlugin</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea7574738859-2\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">Scope</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">VAL1</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">VAL2</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ea7574738859-3\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0005 seconds] -->\n<p></p>\n<h3 id=\"title-6\">4.2. 爱恨交加的 decorator 及依赖注入</h3>\n<p>很不幸，仅仅是解决了编译对象丢失的问题，代码依旧无法运行。程序在初始化的时候，依旧迷之失败了，经过一番调试，发现，初始化流程有一些微妙的不同。很明显，transpileOnly 开启的情况下，编译的结果发生了变化。<br>\n要解决这个问题，就需要对 transpileOnly 模式的实现一探究竟了。transpileOnly 底层是基于 tsc 的 transpileModule 功能来实现的，transpileModule 的作用，是将每一个文件当做独立的个体进行解析，每一个 import 都会被当做一个整体模块来看待，编译器不会再解析模块导出与文件的具体关系，举个例子：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805eaa892572455\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-6\" style=\"height: 20px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-7\" style=\"height: 20px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-8\" style=\"height: 20px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-9\" style=\"height: 20px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-10\" style=\"height: 20px;\">10</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-11\" style=\"height: 20px;\">11</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-12\" style=\"height: 20px;\">12</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-13\" style=\"height: 20px;\">13</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eaa892572455-14\" style=\"height: 20px;\">14</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-1\"><span class=\"crayon-c\">// src/base/a.ts</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-2\"><span class=\"crayon-e\">export</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">A</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-3\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-4\"><span class=\"crayon-c\">// src/base/b.ts</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-5\"><span class=\"crayon-e\">export</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">B</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-7\"><span class=\"crayon-c\">// src/base/index.ts</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-8\"><span class=\"crayon-v\">export</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'./a'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-9\"><span class=\"crayon-v\">export</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'./b'</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-11\"><span class=\"crayon-c\">// src/app.ts</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-12\"><span class=\"crayon-e\">import</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">A</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'./base'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-13\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805eaa892572455-14\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">A</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0011 seconds] -->\n<p></p>\n<p>如上是常见的代码写法，我们往往会通过一个 index.ts 导出 base 中的模块，这样，在其他模块中，笔者就不需要引用到文件了。在正常模式下，编辑器解析这段代码，会附带信息，告知 webpack，A 是由 a.ts 导出的，因此，webpack 在打包时，可以根据具体场景将 A、B 打包到不同的文件中。但是，在 transpileModule 模式下，webpack 所知道的，只有 base 模块导出了 A，但是它并不知道 A 具体是由哪个文件导出的，因此，此时的 webpack 一定会将 A、B 打包到一个文件中，作为一整个模块，提供给 App。对于腾讯文档，这个情况发生了如下变化（模块按照 1、2、3、4、5 的顺序进行加载，模块的视觉大小表示体积大小）：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-10.png\" alt=\"\" width=\"945\" height=\"327\" class=\"aligncenter size-full wp-image-14897\"></p>\n<p>可以看到，在 transpileOnly 开启的情况下，大量的文件被打包到了模块 1 中，被提前加载了。不过，一般情况下，模块被打包到什么位置，并不应该影响代码的表现，不是么？毕竟，关闭 code splitting，代码是可以不拆包的。对于一般的情况而言，这样理解并没有错。但是，对于使用了 decorator 的项目而言，就不适用了。在代码普遍会转为 es5 的时代，decorator 会被转换为一个__decorator 函数，这个函数，是代码加载时的一个自执行函数。如果代码打包的顺序发生了变化，那么自执行函数的执行顺序也就可能发生了变化。那么，这又如何导致了腾讯文档无法正常启动呢？这，就要从腾讯文档全面引入依赖注入技术开始说起。</p>\n<p>在腾讯文档中，每一个功能都是一个 feature，这个 feature 并不会手动初始化，而是通过一个特殊装饰器，注入到腾讯文档的 DI 框架中，然后，由注入框架进行统一的实例创建。举个例子，在正常的变一下，由三个 Feature A、B、C，A、B 被编译在模块 1 中，C 被编译到模块 2 中。在模块 1 加载时，workbench 会进行一轮实例创建和初始化，此时，FeatureA 的初始化带来了某个副作用。然后，模块 2 加载了，workbench 再次进行一轮实力创建和初始化，此时 FeatureC 的初始化依赖了 FeatureA 的副作用，但是第一轮初始化已经结束，因此 C 顺利实例化了。</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-11.png\" alt=\"\" width=\"945\" height=\"770\" class=\"aligncenter size-full wp-image-14898\"></div>\n<p>当 transpileOnly 被开启式，一切变了样，由于无法区分导出，Feature A、B、C 被打包到同一个模块了。可想而知，在 Feature C 初始化时，由于副作用尚未发生，C 的初始化就失败了。</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-12.png\" alt=\"\" width=\"945\" height=\"256\" class=\"aligncenter size-full wp-image-14899\"></div>\n<p>既然 transpileOnly 与依赖注入先天不兼容，那笔者就需要想办法修复它。如果，笔者将 app 中的引用进行替换：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805eae412032720\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eae412032720-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eae412032720-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eae412032720-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eae412032720-4\" style=\"height: 20px;\">4</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805eae412032720-1\"><span class=\"crayon-c\">// src/app.ts</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eae412032720-2\"><span class=\"crayon-e\">import</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">A</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'./base/a'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eae412032720-3\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805eae412032720-4\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">A</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0006 seconds] -->\n<p></p>\n<p>模块导出的解析问题，是否就迎刃而解了？不过，这么多的代码，改成这样的引用，不但难看，反人类，工作量也很大。因此，让笔者设计一个 plugin/loader 组合在编译时来解决问题吧。在编译的初始阶段，笔者通过一个 plugin，对项目文件进行解析，将其中的 export 提取出来，找到每一个 export 和文件的对应关系，并储存起来（此处，可能大家会担心 IO 读写对性能的影响，考虑到现在开发人均都是高速 SSD，这点 IO 吞吐真的不算什么，实测这个 export 解析&lt;1s），然后在编译过程中，笔者再通过一个自定义的 loader 将对应的 import 语句进行替换，这样，就可以实现在不影响正常写代码的情况下，保持 transpileOnly 解析的有效性了。</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-13.png\" alt=\"\" width=\"945\" height=\"268\" class=\"aligncenter size-full wp-image-14900\"></div>\n<p>经过一番折腾，终于，成功的将腾讯文档在高速编译模式下运行了起来，达到了预定的编译速度。</p>\n<h2>5.Webpack5 升级之路</h2>\n<h3 id=\"title-7\">5.1. 一些兼容问题处理</h3>\n<p>Webpack5 毕竟属于一次非兼容的大升级，在腾讯文档编译系统重构的过程中，也遇到诸多问题。</p>\n<p>5.1.1.  SplitChunks 自定义 ChunkGroups 报错</p>\n<p>如果你也是 splitChunks 的重度用户，在升级 webpack5 的过程中，你可能会遇到如下警告：</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-14.png\" alt=\"\" width=\"945\" height=\"145\" class=\"aligncenter size-full wp-image-14901\"></div>\n<p>这个警告的说明并不是十分明确，用大白话来说，出现了这个提示，说明你的 chunkGroups 配置中，出现了 module 同时属于 A、B 两组（此处 A、B 是两个 Entrypoint 或者两个异步模块），但是你明确指定了将模块属于 A 的情况。为何此时 Webpack5 会报出警告呢？因为从通常情况来说，module 分属于两个 Entrypoint 或者异步模块，module 应该被提取为公共模块的，如果 module 被归属于 A，那么 B 模块如果单独加载，就无法成功了。</p>\n<p>不过，一般来说，出现这样的指定，如果不是配置错误，那就是 A、B 之间已经有明确的加载顺序。但是这个加载顺序，Webpack 并不知道。对于 entrypoint，webpack5 中，允许通过 dependOn 属性，指定 entry 之间的依赖关系。但是对于异步模块，则没有这么遍历的设置。当然，笔者也可以通过自定义插件，在 optimize 之前，对已有的模块依赖关系以及修改，保证 webpack 能够知晓额外的信息：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805eb4540847597\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-1\" style=\"height: 60px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-2\" style=\"height: 40px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-3\" style=\"height: 40px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-4\" style=\"height: 40px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-6\" style=\"height: 40px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-7\" style=\"height: 60px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-8\" style=\"height: 40px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-9\" style=\"height: 40px;\">9</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-10\" style=\"height: 40px;\">10</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-11\" style=\"height: 20px;\">11</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-12\" style=\"height: 20px;\">12</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-13\" style=\"height: 20px;\">13</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-14\" style=\"height: 20px;\">14</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-15\" style=\"height: 20px;\">15</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eb4540847597-16\" style=\"height: 20px;\">16</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-1\"><span class=\"crayon-v\">compiler</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">hooks</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">thisCompilation</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">tap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'DependOnPlugin'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">compilation</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-2\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">compilation</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">hooks</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">optimize</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">tap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'DependOnPlugin'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">dependencies</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">parentNames</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">childName</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">compilation</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">namedChunkGroups</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">childName</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">parentNames</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">parentName</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">compilation</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">namedChunkGroups</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">parentName</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">hasParent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">addChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">addParent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-15\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eb4540847597-16\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0028 seconds] -->\n<p></p>\n<h4>5.1.2.plugin 依赖的 api 已删除</h4>\n<p>Webpack5 发布后，各大主流 plugin 都已经相继适配，大家只要将插件更新到最新版本即可。不过，也有一些插件因为诸多缘由，一些插件并没有及时更新。（PS：目前，没有匹配的插件大多已经比较小众了。）总之，这个问题是比较无解的，不过可以适当等待，应该在近期，大部分插件都会适配 webpack5，事实上 webpack5 也是用了不少改名大法，部分接口进行转移，调用方式发生了改变，倒也没有全部翻天覆地的变化，所以，实在等不及的小插件不妨试试自己 fork 修改一下。</p>\n<h3 id=\"title-8\">5.2.Module Federation 初体验</h3>\n<p>通常，对于一个大型项目来说，笔者会抽取很多公共的组件来提高项目间的模块共享，但是，这些模块之间，难免会有一些共同依赖，比如 React、ReactDOM，JQuery 之类的基础库。这样，就容易造成一个问题，公共组件抽取后，项目体积膨胀了。随着公共组件的增多，项目体积的膨胀变得十分可怕。在传统打包模型上，笔者摸索出了一套简单有效的方法，对于公共组件，笔者使用 external，将这些公共部分抠出来，变成一个残疾的组件。</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-15.png\" alt=\"\" height=\"180\" class=\"aligncenter size-full wp-image-14902\"></div>\n<p>但是，随着组件的增多，共享组件的 Host 增多，这样的方式带来了一些问题：</p>\n<ol>\n<li>\n<p>Component 需要为 Host 专门打包，它不是一个可以独立运行的组件，每一个运行该 Component 的 Host 必须携带完整的运行时，否则 Component 就需要为不同的 Host 打出不同的残疾包。</p>\n</li>\n<li>\n<p>Component 与 Component 之间如果存在较大的共享模块，无法通过 external 解决。</p>\n</li>\n</ol>\n<p>这个时候，Module Federation 出现了，它是 Webpack 从静态打包到完整运行时的一个转变，Module Federation 中，提出了 Host 和 Remote 的概念。Remote 中的内容可以被 Host 消费，而在这个消费过程中，可以通过 webpack 的动态加载运行时，只加载其中需要的部分，对于已经存在的部分，则不作二次加载。（下图中，由于 host 中已经包含了 jQuery、react 和 dui，Webpack 的运行时将只加载 Remote1 中的 Component1 和 Remote2 中的 Component2。）</p>\n<div style=\"text-align: center;\">\n<img src=\"http://www.alloyteam.com/wp-content/uploads/2020/12/wp5-16.png\" alt=\"\" height=\"400\" class=\"aligncenter size-full wp-image-14903\"></div>\n<p>也就是说，公共组件作为一个 Remote，它包含了完整的运行时，Host 无需知道需要准备什么样的运行时才可以运行 Remote，但是 Webpack 的加载器保证了共享的代码不作加载。如此一来，就避免了传统 external 打包模式下的诸多问题。事实上，一个组件可以同时是 Host 和 Remote，也就是说，一个程序既可以作为主程运行，也可以作为一个在线的 sdk 仓库。关于 Module Federation 的实现原理，此处不再赘述，大家感兴趣可以参考<a href=\"http://www.alloyteam.com/2020/04/14338/\">探索 webpack5 新特性 Module federation 在腾讯文档的应用</a>中的解析，也可以多多参考 <a href=\"https://github.com/module-federation/module-federation-examples\">module-federation-examples</a> 这个仓库中的实例。</p>\n<p>Webpack5 的 Module Federation 是依赖于其动态加载机制的，因此，在它的演示实例中，你都可以看到这样的结构：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805eba147820411\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eba147820411-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eba147820411-2\" style=\"height: 20px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eba147820411-3\" style=\"height: 20px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eba147820411-4\" style=\"height: 20px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eba147820411-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eba147820411-6\" style=\"height: 40px;\">6</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eba147820411-7\" style=\"height: 20px;\">7</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eba147820411-8\" style=\"height: 20px;\">8</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805eba147820411-9\" style=\"height: 20px;\">9</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805eba147820411-1\"><span class=\"crayon-c\">// bootstrap.js</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eba147820411-2\"><span class=\"crayon-e\">import </span><span class=\"crayon-e\">App </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"./App\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eba147820411-3\"><span class=\"crayon-e\">import </span><span class=\"crayon-e\">React </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"react\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eba147820411-4\"><span class=\"crayon-e\">import </span><span class=\"crayon-e\">ReactDOM </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"react-dom\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eba147820411-5\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805eba147820411-6\"><span class=\"crayon-v\">ReactDOM</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">render</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">App</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">document</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getElementById</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"root\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eba147820411-7\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-649c2e6805eba147820411-8\"><span class=\"crayon-c\">// index.js</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805eba147820411-9\"><span class=\"crayon-e\">import</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./bootstrap.js'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0009 seconds] -->\n<p></p>\n<p>而 Webpack 的入口配置，都设置在了 index.js 上，这里，是因为所有的依赖都需要动态判定加载，如果不把入口变成一个异步的 chunk，那如何去保障依赖能够按顺序加载内？毕竟实现 Moudle Federation 的核心是 基于 webpack_require 的动态加载系统。由于 Module Federation 需要多个仓库的联动，它的推进必然是相对漫长的过程。那么笔者是否有必要将现有的项目直接改造为 index-bootstrap 结构呢？事实上，笔者依然可以利用 Webpack 的插件机制，动态实现这一个异步化过程：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805ebe399868560\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ebe399868560-1\" style=\"height: 40px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ebe399868560-2\" style=\"height: 40px;\">2</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ebe399868560-3\" style=\"height: 60px;\">3</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ebe399868560-4\" style=\"height: 60px;\">4</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ebe399868560-5\" style=\"height: 20px;\">5</div><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ebe399868560-6\" style=\"height: 20px;\">6</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805ebe399868560-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bootstrapEntry</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">entrypoint</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ebe399868560-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">parsed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">parse</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">entrypoint</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ebe399868560-3\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">bootstrapPath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">join</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">parsed</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">dir</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">parsed</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">}</span><span class=\"crayon-e\">_bootstrap</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">parsed</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ext</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ebe399868560-4\"><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">virtualModules</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">bootstrapPath</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-e\">import</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./${parsed.name}${parsed.ext}'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ebe399868560-5\"><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">bootstrapPath</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c2e6805ebe399868560-6\"><span class=\"crayon-sy\">}</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0014 seconds] -->\n<p></p>\n<p>在上述的 bootstrapEntry 方法中，笔者基于原本的 entrypoint 文件，创建一个虚拟文件，这个文件的内容就是：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c2e6805ec1736380609\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c2e6805ec1736380609-1\" style=\"height: 20px;\">1</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c2e6805ec1736380609-1\"><span class=\"crayon-e\">import</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./entrypoint.ts'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0002 seconds] -->\n<p></p>\n<p>再通过 webpack-virtual-modules 这个插件，在相同目录生成一个虚拟文件，将原本的入口进行替换，就完成了 module-federation 的结构转换。这样，配合一些其他的相应配置，笔者就可以通过一个简单参数开启和关闭 module-federation，把项目变成一个 Webpack5 ready 的结构，当相关项目陆续适配成功，便可以一起欢乐的上线了。</p>\n<h2>6. 后记</h2>\n<p>对编译的大重构是笔者蓄谋已久的事情，犹记得加入团队之时，第一次接触到编译链路如此复杂的项目，深感自己的项目经历太浅，接触的编译和打包都如此简单，如今亲自操刀才知道，这中间除了许多技术难题，大项目必有的祖传配置也是阻碍项目进步的一大阻力。</p>\n<p>Webpack 5 的 Beta 周期很长，所以在 Webpack5 发布之后，兼容问题还真不如预想的那么多，不过 Webpack5 的文档有些坑，如果不是使用 NodeApi 的时候，有类型声明，笔者绝对无法发现官方不少文档的给的参数还是 webpack4 的旧数据，对不上号。于是不得不埋着头调试源代码，寻找正确的配置方式，不过也因此收获良多。并且 Webpack5 还在持续迭代中，还存在一些 bug，比如 Module Federation 中使用了不恰当的配置，可能会导致奇怪的编译结果，并且不会报错。所以，遇到问题大家要大胆的提 issue。本次重构的经验就暂时说到这儿，如有不当之处，欢迎斧正。</p>\n<p>最后，腾讯文档大量招人，如果你也想来研究这么有趣的技术，欢迎加入腾讯文档的大家庭，欢迎联系笔者 <a href=\"mailto:glendonzli@qq.com\">glendonzli@qq.com</a>。</p>\n\t"
  },
  {
    "id": 6,
    "tags": ["JavaScript"],
    "title": "初探 Typescript 解析器",
    "author": "TAT.老教授",
    "avatar": "http://www.alloyteam.com/wp-content/uploads/2012/11/weberpan_avatar-43x43.jpg",
    "date": "2020-08-24T20:17:51+00:00",
    "separator": "6401",
    "content": "\n\t\t<h3 id=\"title-0\">前言</h3>\n<p>前段时间看了下开源组件 stryker 的源码，对 Typescript 的解析器产生了兴趣。这个开源组件是用来检查单测质量的，通过识别源码自动更改某些代码内容，然后看单测能否检测出来。Typescript 解析器做的，就是识别源码这一关键步骤。</p>\n<p>于是花了些时间学了下 Typescript 解析器，感觉像打开一个新的大门，可以玩很多有趣的事情。</p>\n<p>附：stryke (<a href=\"https://link.zhihu.com/?target=https%3A//github.com/stryker-mutator/stryker/tree/master\">https://github.com/stryker-mutator/stryker/tree/master</a>)</p>\n<h3 id=\"title-1\">最基础，生成 AST</h3>\n<p>翻了下 Stryker 的源码，发现应用 Typescript 解析器的关键语句如下：</p>\n<p><span id=\"more-14850\"></span></p>\n<pre><code class=\"language-javascript\">export function parseFile(file: File, target: ts.ScriptTarget | undefined) {\n  return ts.createSourceFile(file.name, file.textContent, target || ts.ScriptTarget.ES5, /*setParentNodes*/ true);\n}</code></pre>\n<p>而前面引入 ts 模块：</p>\n<pre><code class=\"language-js\">import * as ts from 'typescript';</code></pre>\n<p>createSourceFile 函数参数一随便写就行，参数二传 Typescript 代码，后面两参数保持默认即可，最后输出来的就是一颗抽象语法树（AST）。</p>\n<p>你可以通过 nodejs 的断点调试查看这个树每个节点的内容。不过我在网上四处翻了下，找到了可以语义化打出树结构的代码，更方便：</p>\n<pre><code class=\"language-js\">// 打印 TS 的语法树\nconst printAllChildren = (node: ts.Node, depth = 0) =&gt; {\n  console.log(new Array(depth + 1).join('----'), ts.SyntaxKind[node.kind], node.pos, node.end);\n  node.getChildren().forEach((c) =&gt; printAllChildren(c, depth + 1));\n};</code></pre>\n<p>此时我使用下面的源码测试：</p>\n<pre><code class=\"language-js\">export const test = (a: number) =&gt; a + 2;\nexport const test2 = 0;</code></pre>\n<p>输出下图：</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d6a137b2cf5e4c4d9ddab0cec996848c~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>很容易一一对照理解这棵树。</p>\n<p>而 Stryker 插件的原理就是生成 AST，深层遍历每个树节点，对特定树节点进行改造，再重新生成源码（生成回源码用的应该是 ts.createPrinter 的能力，<a href=\"https://link.zhihu.com/?target=https%3A//github.com/microsoft/TypeScript/wiki/Using-the-Compiler-API%23creating-and-printing-a-typescript-ast\">示例</a>）。</p>\n<p>既然现在掌握了生成 AST 和遍历 AST 的方法，那我们可以开始玩点花样了\\~</p>\n<h3 id=\"title-2\">应用：谁写了最多的单测用例？</h3>\n<p>假设，项目用 Jest 写单测。</p>\n<p>遍历目录找出单测文件和读取文件内容，这没什么好说的。拿到文件内容我们生成 Typescript 的 AST，开始遍历。</p>\n<p>怎么判断节点是不是 describe 或 test/it ？可以这样</p>\n<pre><code class=\"language-js\">if (ts.SyntaxKind[node.kind] === 'CallExpression') {\n    const funcName = node.expression.escapedText;\n    if (funcName === 'describe') {\n        // TODO\n    } else if (funcName === 'it' || funcName === 'test') {\n        // TODO\n    }\n}</code></pre>\n<p>下一个问题，怎么知道这个单测用例代码块是在哪几行？AST 的每个节点是有对应源码的起始位置和结束位置的，那我们就可以算出是第几行（上一节打印 AST 有打印出来）。这时候要注意，直接使用 pos、end 两个取索引，如果树节点是行头行尾，那有可能把换行符、注释也给包含进去的。</p>\n<p>方法 1：可以用下面的方法通过中间字段避开行头行尾来算行：</p>\n<pre><code class=\"language-js\">else if (funcName === 'it' || funcName === 'test') {\n    const testKeywordNode = node.getChildren()[0];\n    parseInfoList.push({\n        describeName: currDescribe,\n        testName: node.arguments[0].text,\n        lineBegin: getLineNumByPos(fileContent, testKeywordNode.end), // 不使用 pos，避免引入注释\n        lineEnd: getLineNumByPos(fileContent, node.end),\n        expectLines: getExpectLines(fileContent, node) || [],  // 获取所有 expect 所在的行\n    });\n    return;\n}</code></pre>\n<p>而获取文件内容某个位置是在第几行，只要获取前面内容有多少个换行符即可：</p>\n<pre><code class=\"language-js\">const getLineNumByPos = (fileContent, pos) =&gt; {\n    const contentBefore = fileContent.slice(0, pos);\n    // 统计有多少个换行符\n    return (contentBefore.match(/\\n/g) || []).length + 1;\n};</code></pre>\n<p>方法 2：用 TS 封装的接口，TS 提供了 getStart\\getFullStart 等接口，它们的区别是 getFullStart 会含前面的换行和注释（如果有），getStart 不含。至于第几行也是有相应的 api（我为什么不直接用这个？因为我到后面才知道有这个 (╯‵□′)╯︵┻━┻）：</p>\n<pre><code class=\"language-js\">const { line, character } = sourceFile.getLineAndCharacterOfPosition(node.getStart());</code></pre>\n<p>做到这里就把难点完成了，后面无非就是通过 git 的 blame 命令获取用例代码所在的行的作者来分析出用例的作者，不是本文重点不展开。</p>\n<h3 id=\"title-3\">进阶：使用 Typescript 上层接口</h3>\n<p>createSourceFile 还是很好用的，通过分析 AST 树可以做很多事情，但是它的缺点也很明显：</p>\n<ol>\n<li>作为底层 API，关注的是底层的单个文件每一个 token 分别是什么类型，却没法得到上层的联系。比如 Typescript 的类型推断就没法通过只看一个 token 来得到，有些类型推断甚至需要跨文件，这是 AST 树没法获知到的；</li>\n<li>只能根据代码的层级逐层向下遍历，遇到同样功能多种写法的情况就要兼容辨别，而且还没提供 AST 树向上走的接口，对写相关功能造成了很多不便；</li>\n</ol>\n<p>关于这个，Typescript 的解析器能力已经帮我们把整体架构好了，并不是刀耕火种从 AST 来撸代码。这是架构图（源自 Typescript 的 GitHub wiki）</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a38add5cee5442b292bf4712706b63e2~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>Wiki 地址是：<a href=\"https://link.zhihu.com/?target=https%3A//github.com/microsoft/TypeScript/wiki/Architectural-Overview\">https://github.com/microsoft/TypeScript/wiki/Architectural-Overview</a>，虽是英文但挺好懂的，推荐读一读。</p>\n<p>里面有对整体解析流程做了介绍，生成 AST 只是最初的步骤，也讲了一些概念，个人觉得比较有意思的概念是下面几个：</p>\n<h4>Program</h4>\n<p>SourceTree 是单个文件的结构，多个 SourceTree 相互关联就组成一个 Program。可以通过一组源文件来创建 Program 也可以是单个源文件，此时类似 webpack 从主入口找文件一样，Typescript 会将源文件所有引用到的文件都给引入 Program 里面并做解析处理：</p>\n<pre><code class=\"language-js\">this.program = ts.createProgram([this.srcFile], {\n    target: ts.ScriptTarget.ES5,\n    module: ts.ModuleKind.CommonJS,\n});</code></pre>\n<p>因为相关文件都被引入进来了，于是就可以发现文件和文件的关联、代码和代码的关联，所以不少高级功能是基于 Program 的基础的。</p>\n<h4>TypeChecker</h4>\n<p>听名字就知道这是做类型检查的，类型推测功能就是它提供的。从 Program 里创建出来：</p>\n<pre><code class=\"language-js\">this.checker = this.program.getTypeChecker();</code></pre>\n<p>然后就可以做各种类型事情了，比如获取某个函数的入参出参类型：</p>\n<pre><code class=\"language-js\">const getFunctionTypeInfoFromSignature = (signature: ts.Signature, checker: ts.TypeChecker): IFunctionTypeInfo =&gt; {\n  // 获取参数类型\n  const paramTypeStrList = signature.parameters.map((parameter) =&gt; {\n    return checker.typeToString(checker.getTypeOfSymbolAtLocation(parameter, parameter.valueDeclaration));\n  });\n\n  // 获取返回值类型\n  const returnType = signature.getReturnType();\n  const returnTypeStr = checker.typeToString(returnType);\n\n  return {\n    paramTypes: paramTypeStrList,\n    returnType: returnTypeStr,\n  };\n};\n\nexport const getFunctionTypeInfoByNode = (\n  node: ts.ArrowFunction | ts.FunctionDeclaration | ts.MethodDeclaration,\n  checker: ts.TypeChecker,\n): IFunctionTypeInfo =&gt; {\n  const tsType = checker.getTypeAtLocation(node);\n  return getFunctionTypeInfoFromSignature(tsType.getCallSignatures()[0], checker);\n};</code></pre>\n<p>这里你会看到 getCallsignatures 返回一个数组，因为 Typescript 是支持函数重构的。</p>\n<p>在使用 TypeChecker 的过程中你会注意到另一个重要的概念：</p>\n<h4>Symbol</h4>\n<p>AST 的每个节点是 Node，那 Symbol 和 Node 又是什么区别？</p>\n<p>简单说，Node 就是代码的一个语法块，它可能是变量名，可能是 function 之类的关键字，可能是代码块，而 Symbol 正如其名就是一个标志，每一个 Symbol 就类似我们在控制台调试时输入的变量名。两个函数里面可能局部定义了名称相同的两个变量，但它们属于不同的 Symbol；A.ts 导出的变量 a 在 B.ts 里使用，对应的是同一个 Symbol。</p>\n<p>个人觉得 Symbol 的作用主要是：</p>\n<p><strong>上层解析</strong>，比如一个变量定义，Node 数据结构可以理解为一堆初始数据，获取变量名还要去拿到 name 类型再拿到里面的 text，然后最好再 trim 一下：</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7acaf10ba6144b889b094983f05dd90~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>而转为对应 Symbol 类似于变成高级结构，只需要调用上层接口如：</p>\n<pre><code class=\"language-js\">const symbol = this.checker.getSymbolAtLocation(declaration.name)!;\nconst name = symbol.getName();</code></pre>\n<p>包括拿到 class 的 Symbol 就很容易可以通过调用一个接口拿到构造函数的数据，而不用管它藏得多深。</p>\n<pre><code class=\"language-js\">const symbol = checker.getSymbolAtLocation(node.name);\nif (!symbol) {\n  return null;\n}\n\nconst tsType = checker.getTypeOfSymbolAtLocation(symbol, symbol.valueDeclaration);\nconst signature = tsType.getConstructSignatures()[0];</code></pre>\n<p><strong>类型关联</strong>。同个 Symbol 它的类型是固定的，即使它在两个不同的文件使用到。不过我发现可以通过 Symbol 获取 Type，也可以通过 Node 获取 Type，那 Symbol 的这个作用感觉不太需要用到。</p>\n<p>更多的 Typescript 解析器内容可深入阅读 Typescript 的 wiki，想要直接看代码来理解 wiki 里也有提供几个案例：<a href=\"https://link.zhihu.com/?target=https%3A//github.com/microsoft/TypeScript/wiki/Using-the-Compiler-API\">https://github.com/microsoft/TypeScript/wiki/Using-the-Compiler-API</a></p>\n<p>理解了这些概念，相同的功能我们就不需要基于 AST 树写一堆代码，而是可以用更优雅的方式实现。</p>\n<h3 id=\"title-4\">别急着开始写，先了解这个网站和这些 API</h3>\n<p>一开始我都是傻傻地用第一节那段代码打印 AST 树，直到我找到下面的网站：<a href=\"https://link.zhihu.com/?target=https%3A//ts-ast-viewer.com/%23\">https://ts-ast-viewer.com/#</a></p>\n<p>功能大致如下：</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bca769b611e4af5a88693ec6cff7b80~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>非常地好用，特别是最右侧的区域，你可以知道每一个 AST 节点有哪些属性和方法（不同种类的 AST 节点有差异），可以很方便地取到相关的数据而不是只能通过一层层遍历。</p>\n<p>而左下侧的窗格你可以结合这个 demo 来看：<a href=\"https://link.zhihu.com/?target=https%3A//github.com/microsoft/TypeScript/wiki/Using-the-Compiler-API%23creating-and-printing-a-typescript-ast\">https://github.com/microsoft/TypeScript/wiki/Using-the-Compiler-API#creating-and-printing-a-typescript-ast</a></p>\n<p>接着说说 Typescript 提供的解析器 API。总的来说，特别吐槽，因为没在 GitHub 上找到解析器的 API 列表，只能看示例及翻一翻 Typescript 的源码来了解。下面我介绍一些我用过觉得好用的：</p>\n<ul>\n<li>类型识别类 API</li>\n</ul>\n<p>参照上面 AST 网站的每一层节点的类型，都有对应的判断函数，如 ts.isClassDeclaration、ts.isArrowFunction 等。</p>\n<p>当然你也可以参考第一节的 demo 用 ts.SyntaxKind[node.kind] === 'VariableStatement' 的形式判断，但使用标准接口对 TS 更友好：</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f8f94ef1a3e54b32bc05fee9e77a27be~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<ul>\n<li>检测 modifierFlag 的 API</li>\n</ul>\n<p>modifierFlag，可以简单理解为修饰标志，如 public、private、async 这些，可以在上面的 AST 查看网站上看到：</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/368c2efa7f5047209a6f8d42701ebe8d~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"\"></p>\n<p>而要判断一个树节点是否有某个标志，可以参考下面的写法：</p>\n<pre><code class=\"language-js\">export const isNodeExported = (node: ts.Node): boolean =&gt; {\n  return (ts.getCombinedModifierFlags(node as ts.Declaration) &amp; ts.ModifierFlags.Export) !== 0;\n};</code></pre>\n<p>更多的好用 API 我还在探索中。</p>\n<h3 id=\"title-5\">应用：获取一个类的所有成员及它们的类型定义</h3>\n<p>流程：</p>\n<pre><code class=\"language-js\">private analyseExportNodeForClass(node: ts.ClassDeclaration) {\n  const className = node.name?.getFullText().trim() || '';\n  const classMemeberInfoList: IClassMemberInfo[] = [];\n\n  node.members.forEach((member) =&gt; {\n    if (!ts.isPropertyDeclaration(member) &amp;&amp; !ts.isMethodDeclaration(member)) {\n      return;\n    }\n\n    const { name, type, funcArgsType } = ts.isPropertyDeclaration(member)\n      ? this.getBasicInfoFromVarDeclaration(member)\n      : this.getBasicInfoFromFuncDeclaration(member);\n    const accessibility = getClassAccessibility(member);\n\n    console.log('name', name);\n    console.log('type', type);\n    console.log('funcArgsType', funcArgsType);\n    console.log('');\n\n    classMemeberInfoList.push({\n      name,\n      type,\n      funcArgsType,\n      accessibility,\n    });\n  });\n\n  // 构造函数单独处理\n  const constructorParamType = this.getConstructorParamType(node);\n\n  // TODO 输出相关变量\n  console.log(className, classMemeberInfoList, constructorParamType);\n}</code></pre>\n<p>其中获取成员函数的定义和类型：</p>\n<pre><code class=\"language-js\">private getBasicInfoFromFuncDeclaration(declaration: ts.FunctionDeclaration | ts.MethodDeclaration) {\n  const symbol = this.checker.getSymbolAtLocation(declaration.name!)!;\n  const name = symbol.getName();\n  const typeInfo = getFunctionTypeInfoByNode(declaration, this.checker);\n  const type = typeInfo.returnType;\n  const funcArgsType = typeInfo.paramTypes;\n\n  return {\n    name,\n    type,\n    funcArgsType,\n  };\n}\n\n// utils.ts\nexport const getFunctionTypeInfoByNode = (\n  node: ts.ArrowFunction | ts.FunctionDeclaration | ts.MethodDeclaration,\n  checker: ts.TypeChecker,\n): IFunctionTypeInfo =&gt; {\n  const tsType = checker.getTypeAtLocation(node);\n  return getFunctionTypeInfoFromSignature(tsType.getCallSignatures()[0], checker);\n};\n\nconst getFunctionTypeInfoFromSignature = (signature: ts.Signature, checker: ts.TypeChecker): IFunctionTypeInfo =&gt; {\n  // 获取参数类型\n  const paramTypeStrList = signature.parameters.map((parameter) =&gt; {\n    return checker.typeToString(checker.getTypeOfSymbolAtLocation(parameter, parameter.valueDeclaration));\n  });\n\n  // 获取返回值类型\n  const returnType = signature.getReturnType();\n  const returnTypeStr = checker.typeToString(returnType);\n\n  return {\n    paramTypes: paramTypeStrList,\n    returnType: returnTypeStr,\n  };\n};</code></pre>\n<p>获取成员属性就比较简单了，不赘述。</p>\n<p>获取构造函数类型：</p>\n<pre><code class=\"language-js\">private getConstructorParamType(node: ts.ClassDeclaration) {\n  const constructorInfo = getConstructorInfo(node, this.checker);\n  const constructorParamType: string[] = constructorInfo\n    ? constructorInfo.paramTypes\n    : [];\n\n  return constructorParamType;\n}\n\n// utils.ts\nexport const getConstructorInfo = (node: ts.ClassDeclaration, checker: ts.TypeChecker): IFunctionTypeInfo | null =&gt; {\n  if (!node.name) {\n    return null;\n  }\n\n  const symbol = checker.getSymbolAtLocation(node.name);\n  if (!symbol) {\n    return null;\n  }\n\n  const tsType = checker.getTypeOfSymbolAtLocation(symbol, symbol.valueDeclaration);\n  const signature = tsType.getConstructSignatures()[0];\n\n  if (!signature) {\n    return null;\n  }\n\n  return getFunctionTypeInfoFromSignature(signature, checker);\n};</code></pre>\n<p>而如果想知道每个成员的开放程度，可这样处理：</p>\n<pre><code class=\"language-js\">export const getClassAccessibility = (node: ts.PropertyDeclaration | ts.MethodDeclaration) =&gt; {\n  // const hasPublic = (ts.getCombinedModifierFlags(node) &amp; ts.ModifierFlags.Public) !== 0;\n  const hasPrivate = (ts.getCombinedModifierFlags(node) &amp; ts.ModifierFlags.Private) !== 0;\n  const hasProtect = (ts.getCombinedModifierFlags(node) &amp; ts.ModifierFlags.Protected) !== 0;\n\n  return hasProtect ? ts.ModifierFlags.Protected : hasPrivate ? ts.ModifierFlags.Private : ts.ModifierFlags.Public;\n};</code></pre>\n<p>至此，一个类里面该有的信息都可以获取到了。当然实际情况还有一些特殊场景，如静态成员，如 getter 等，参照着 AST 查看网站的结构可以大致推断出该使用什么 API。</p>\n<p>获取到类信息我们就可以做不少事情，比如全自动输出每个类的接口文档？全自动 mock 一个类的实例？可以想象的空间很多\\~</p>\n<h3 id=\"title-6\">总结</h3>\n<p>侃了这么多，可能就摸到了 Typescript 解析器的冰山一角而已。随着 Typescript 的使用率越来越高，了解 Typescript 解析器并编写相关工具将变成一件又有意义又有些挑战性的事情，期待看到更多的工具\\~</p>\n<p>注：相关参考文档</p>\n<ul>\n<li>官方 wiki：<a href=\"https://link.zhihu.com/?target=https%3A//github.com/microsoft/TypeScript/wiki/Architectural-Overview\">https://github.com/microsoft/TypeScript/wiki/Architectural-Overview</a></li>\n<li>深入理解 Typescript：<a href=\"https://link.zhihu.com/?target=https%3A//jkchao.github.io/typescript-book-chinese/compiler/overview.html\">https://jkchao.github.io/typescript-book-chinese/compiler/overview.html</a></li>\n</ul>\n\t"
  },
  {
    "id": 7,
    "tags": ["WEB开发"],
    "title": "前端开发中聊天场景的体验优化",
    "author": "TAT.steph",
    "avatar": "http://www.alloyteam.com/wp-content/uploads/2020/07/TAT.steph_avatar_1595907201-43x43.png",
    "date": "2020-04-29T20:55:37+00:00",
    "separator": "12136",
    "content": "\n\t\t<p>在最近的开发工作中，遇到了一个聊天场景的应用（Web 和小程序），类似于我们再熟悉不过的 QQ 和微信，一个正常的聊天界面是大致上是长这个样子的：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/img1-1.png\" alt=\"\" width=\"200\"><br>\n<span id=\"more-14349\"></span></p>\n<p>这种聊天窗口的消息流有两个明显的特点：一是最新的消息和滚动条初始位置需要在列表的最底部，二是下拉加载历史消息后要在当前消息列表的顶部进行衔接。</p>\n<p>一般来说要实现这样的功能，对于前端开发来说都不是难事，只要两步就可以了：首先，在第一屏消息渲染完之后设置容器的 <code>scrollTop</code> 为一个极大值，这样就把最新消息和滚动条初始位置定位到了最底部；然后，当滚动到顶部时渲染第二屏数据，接着设置容器的 <code>scrollTop</code> 为衔接的位置（也就是第二屏的总高度），这样就实现了前后两屏消息的衔接。这样的 demo 只需要随手撸二三十行代码就实现了：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/video1.gif\" alt=\"\"></p>\n<p>一开始渲染消息 1~20，滚到顶部后渲染第二屏消息 ABCDEFGHIJK，看上去前后两屏消息的衔接很平滑很流畅。目前开源社区中也有很多现成的用 React 和 Vue 开发的聊天组件或者示例，他们基本也是用上面提到的思路或者借助 iScroll 实现的。</p>\n<p>用上面这种思路跑在 Web 中是没有任何问题的，但是在小程序中的表现却大失所望，看一下用同样的方式应用到小程序后的实际效果：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/video2.gif\" alt=\"\" width=\"300\" style=\"margin-right:10px;\"><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/video3.gif\" alt=\"\" width=\"300\"></p>\n<p>从第一段视频（左）可以看到从列表进入到聊天页面后设置滚动条位置到底部发生了明显的跳动，先看到停留在顶部然后瞬间再去到底部；第二段视频（右）滚动到顶部加载后，下一屏消息与当前消息的衔接出现了一个明显的跳动，也是先看到在顶部然后才去到预期的位置。</p>\n<p>为什么这个思路在 Web 端体验这么好，到了小程序上体验就如此糟糕呢？原因其实很简单，这是由于小程序底层通信逻辑和视图更新机制造成的：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/img2.png\" alt=\"\"></p>\n<p>由于小程序跨线程通信和异步更新的特点，内容的渲染和滚动位置的设置无法保证完成的先后顺序，所以必然会先看到上一个位置一闪而过的画面。</p>\n<p>既然是底层的问题，那么这种聊天场景在小程序中难道就玩不了了吗？当然也有尝试过用 <code>opacity</code> 过渡和滚动动画去缓解这种跳动，但都无法从根本上解决这两个体验问题。</p>\n<p>当各种常规方案尝试都不尽满意的时候，那就换个思路：从本质上来说，聊天窗口的消息流实际上是一个 <strong>“反自然”</strong> 的列表，因为在计算机的 “自然界” 和人们习以为常的使用方式上，列表的初始位置都是在最顶部，想要浏览列表更多的内容需要向下滚动，而聊天场景的特点是完全反常规的！</p>\n<p>再回到这两个体验问题：为什么需要手动设置最新消息和滚动条到最底部，为什么不让它一开始就在底部？为什么需要要在列表顶部追加数据，为什么不让它在底部追加数据？所以有没有可能颠倒常规，做一个 <strong>“反向渲染”</strong>的滚动列表呢？答案是肯定的！</p>\n<p>首先像常规的列表一样去渲染，不需要做任何处理，第一条最新消息和滚动条的初始位置是自然地在最上面：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/img3.png\" alt=\"\" width=\"160\"></p>\n<p>然后把整个列表区域的包裹容器用 CSS 旋转 180°，这样第一条最新消息和滚动条初始位置就在最下面下了：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/img4.png\" alt=\"\" width=\"400\"></p>\n<p>不过此时整个列表是倒置渲染的，最后再把每一条消息组件用同样的方式旋转 180° 使它们显示回正常的视角，这样就实现了一个 “反向渲染” 的列表：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/img5.png\" alt=\"\"></p>\n<p>虽然是 “反向渲染”，但视觉上和正常的一模一样。此时顶部就变成了底部，向上追加数据变成了向下追加数据。最后看一下聊天列表使用 “反向渲染” 之后的体验效果：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/video4.gif\" alt=\"\" width=\"300\" style=\"margin-right:10px;\"><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/video5.gif\" alt=\"\" width=\"300\"></p>\n<p>可以看到，下拉加载消息与当前消息的衔接非常平滑没有任何的跳动，实际上这个时候历史消息是在底部渲染的，只不过反向渲染让它看上去是在顶部渲染的；此外，页面一进来最新消息和滚动条位置无需任何处理自然地停留在最底部，接近原生体验。</p>\n<p>这种 “反向渲染” 的思路用最少的代码就解决了消息场景在小程序上这种几乎无解的问题，并且达到了最优的体验，而实际上核心代码只有两行 CSS：</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-649c331d6e456416631982\" class=\"crayon-syntax crayon-theme-turnwall-copy crayon-font-liberation-mono crayon-os-pc print-yes notranslate crayon-wrapped\" data-settings=\" touchscreen minimize scroll-mouseover wrap\" style=\"margin-top: 1px; margin-bottom: 1px; font-size: 14px !important; line-height: 20px !important; height: auto;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"position: relative; z-index: 1;\">\n\t\t\t\t<table class=\"crayon-table\" style=\"\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-649c331d6e456416631982-1\" style=\"height: 20px;\">1</div><div class=\"crayon-num\" data-line=\"crayon-649c331d6e456416631982-2\" style=\"height: 20px;\">2</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-649c331d6e456416631982-1\"><span class=\"crayon-v\">transform</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rotate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">180deg</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-649c331d6e456416631982-2\"><span class=\"crayon-v\">direction</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rtl</span><span class=\"crayon-sy\">;</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0013 seconds] -->\n<p></p>\n<p>整个过程无需任何手动设置滚动位置和计算第二屏总高度（实际上都不用关心它们了），同样这种思路用在 Web 上也是 OK 的。当然用了反向渲染也有一些牺牲，比如 iOS 双击顶部栏回到顶部这个特点就不能用了，但总体来说获得体验上的优化是更多的。</p>\n<p>此外，聊天场景中的消息流通常也有这样的布局：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/img6.png\" alt=\"\" width=\"600\"></p>\n<p>如果视觉上需要将自己和别人的消息方向分别位列两边对齐，那么利用这种 “反向渲染” 的思路，实现起来也非常容易，只需要对消息组件应用不同的 CSS 样式即可：</p>\n<p><img src=\"http://www.alloyteam.com/wp-content/uploads/2020/04/img7.png\" alt=\"\" width=\"600\"></p>\n<p>消息流的每一条消息都是一个单独的组件，此时不需要为了区分不同的视角而去新写一个组件，也不需要改变现有组件的结构布局。</p>\n\t"
  }
]
